<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة الطالب | Student Portal</title>
    
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل مكتبة Lucide Icons لأيقونات واجهة المستخدم -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* خط إنتر (Inter) هو خط حديث وواضح يناسب التصميم */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* لون الخلفية الفاتح */
        }
        /* إخفاء شريط التمرير (Scrollbar) في الـ body للجوال */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* الألوان والثوابت - تم تحديثها لتطابق الألوان في الصورة بدقة */
        :root {
            --primary-green: #2E8B57; /* اللون الأخضر الداكن للملف الشخصي */
            --tile-bg: #00A381; /* لون أزرار الصفحة الرئيسية */
            --nav-bg: #353B47; /* لون الشريط السفلي (كحلي/رمادي غامق) */
            --logout-red: #dc2626; /* لون الأحمر للخروج - red-600 */
        }

        /* تصميم زر القائمة السفلية */
        .nav-item .icon {
            color: #a0aec0; /* لون الرمادي الافتراضي */
            /* إضافة انتقال سلس لتغيير اللون */
            transition: color 0.3s ease-in-out; 
        }
        .nav-item .bg-active {
            /* إضافة انتقال سلس للخلفية والتظليل */
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        
        /* التعديل هنا: لجعله مربعاً بزوايا غير حادة (xl) بدلاً من دائري (full) - التعديل السابق */
        .nav-item .bg-default {
            padding: 0.75rem; /* p-3 */
            border-radius: 9999px; /* rounded-full (دائري) */
        }

        /* حالة النشاط (Active State) */
        .nav-item.active .icon {
            color: #ffffff;
        }
        .nav-item.active .bg-active {
            background-color: var(--tile-bg); /* استخدام لون أزرار الشاشة الرئيسية للأيقونة النشطة */
            /* تطبيق التنسيق المربع الجديد */
            border-radius: 0.75rem; /* rounded-xl (لتكبير الزوايا قليلاً) */
            padding: 1rem; /* p-4 (لتكبير المنطقة الخضراء) */
            box-shadow: none;
            transform: none; 
        }

        /* تعديل تصميم أزرار القائمة السفلية ليتوافق مع الشكل الجديد */
        .nav-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 0.5rem; /* p-2 */
            width: 100%; /* لضمان توزيع متساوي */
        }
        /* إخفاء النص تحت الأيقونة النشطة */
        .nav-item.active .nav-text {
            display: none;
        }
        /* تعديل ترتيب العناصر ليتطابق مع الصورة (الأيقونة أولاً ثم النص، ولكن النص مخفي في حالة النشاط) */
        .nav-item {
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            min-height: 4.5rem; /* ارتفاع تقريبي لشريط التنقل */
            padding: 0 0.5rem;
            flex-grow: 1;
        }
        /* تعديل شريط التنقل ليعمل بشكل صحيح مع التوسيع الأفقي للعنصر النشط */
        .nav-bar-container {
            display: flex;
            justify-content.center;
            width: 100%;
        }
        
        /* لضمان أن التطبيق يملأ الشاشة بالكامل على الجوالات الحديثة (بما في ذلك المساحات الآمنة) */
        .h-screen-safe {
            height: 100vh;
            height: 100svh; /* استخدام svh للأجهزة الحديثة للارتفاع الآمن */
        }

        /* ---------------------------------------------------------------------- */
        /* أنماط البطاقة والتقليب (Card & Flip Animation Styles) */
        /* ---------------------------------------------------------------------- */

        /* حاوية البطاقة الأم (يجب أن تكون ثلاثية الأبعاد) */
        #cardDisplayArea {
            /* المنظور (Perspective) لإنشاء العمق */
            perspective: 1000px;
        }

        /* حاوية البطاقة الداخلية التي سيتم تقليبها */
        .id-card-flipper {
            position: relative;
            /* منع العناصر الداخلية من الانهيار */
            width: 100%; 
            height: 100%;
            /* حركة سلسة للتقليب على محور Y */
            transition: transform 0.6s;
            transform-style: preserve-3d;
            /* يجب أن يبدأ في الوضع العادي (بدون تدوير) */
            transform: rotateY(0deg); 
        }

        /* حالة التقليب (عندما يتم تغيير البطاقة) */
        .id-card-flipper.is-flipping {
            /* تدوير 180 درجة حول محور Y */
            transform: rotateY(180deg);
        }

        /* وجه البطاقة (الأمامي والخلفي) */
        .card-face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* إخفاء الوجه الخلفي (Backface) أثناء الدوران */
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden; /* للمتصفحات القديمة */
            /* تطبيق التنسيق العام للبطاقة */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 1rem; /* rounded-2xl */
            /* التأكد من أن الصور تغطي البطاقة بالكامل */
            background-size: cover !important;
            background-position: center !important;
        }

        /* الوجه الخلفي (بطاقة الإقامة) - يبدأ بـ 180 درجة حتى يظهر عندما يكون Flipper عند 180 درجة */
        .card-face.back {
            /* تدوير الوجه الخلفي مسبقًا ليكون جاهزًا للظهور */
            transform: rotateY(180deg);
        }
        
        /* تنسيق الأبعاد الأساسي للبطاقة */
        .id-card-container {
            /* تعديل الأبعاد لتكون عمودية (طولية) بنسبة 1:1.58 */
            width: 85vw; /* عرض أقل بقليل ليناسب التصميم الطولي */
            max-width: 300px; /* أقصى عرض معقول */
            aspect-ratio: 1 / 1.58; 
            /* منع تحديد النص داخل البطاقة */
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-y; /* السماح بالتمرير العمودي فقط، والتعامل مع الأفقي بالجافاسكريبت */
        }

        /* تنسيق طبقة التعتيم على خلفية البطاقة */
        .card-overlay {
            position: absolute;
            inset: 0;
            /* لون تعتيم خفيف لضمان وضوح النص فوق الصورة */
            background-color: rgba(255, 255, 255, 0.6); 
            z-index: 5; /* يكون أعلى من الخلفية، وأسفل محتوى البطاقة */
            border-radius: 1rem;
        }
        
        /* تنسيق الأزرار الصغيرة للإخفاء/الإظهار */
        .toggle-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* خطوط البيانات داخل البطاقة */
        .card-data-line {
            line-height: 1.1; /* تقليل التباعد بين الأسطر */
        }

    </style>
</head>
<body class="h-screen-safe flex flex-col items-center">

    <!-- الحاوية الرئيسية للتطبيق، محددة بأقصى عرض للهاتف (max-w-md) لتبدو كالتطبيق الأصلي -->
    <div id="app" class="w-full max-w-md h-screen-safe flex flex-col bg-gray-100 overflow-hidden">

        <!-- رأس الصفحة (Header) - تم تعديل الهيكل لثلاثة أجزاء -->
        <header id="header" class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
            <!-- حاوية الإجراءات اليسرى (Left Actions) -->
            <div id="header-left-actions" class="w-10 flex items-center">
                <!-- الإجراءات هنا -->
            </div>
            
            <!-- عنوان الصفحة (Title - Centered) -->
            <h1 id="header-title" class="text-xl font-bold text-gray-800 flex-grow text-center">بوابة الطالب</h1>
            
            <!-- حاوية الإجراءات اليمنى (Right Actions) -->
            <div id="header-right-actions" class="w-10 flex justify-end items-center">
                <img id="profileImageHeader" src="https://placehold.co/40x40/00A381/ffffff?text=U" onerror="this.src='https://placehold.co/40x40/00A381/ffffff?text=U'" alt="ملف شخصي" class="rounded-full w-10 h-10 object-cover border-2 border-[--primary-green]">
            </div>
        </header>

        <!-- محتوى الصفحة (Content) -->
        <main id="content" class="flex-grow overflow-y-auto p-4 space-y-4">
            <!-- سيتم تحميل محتوى الشاشات هنا -->
        </main>

        <!-- قائمة التنقل السفلية (Bottom Navigation Bar) -->
        <nav class="bg-[--nav-bg] p-2">
            <div class="nav-bar-container">
                <!-- زر الرئيسية -->
                <button class="nav-item flex items-center p-0 text-gray-400 active" onclick="navigate('home', this)">
                    <!-- الحاوية الخضراء أو الرمادية -->
                    <div class="bg-active rounded-xl p-4 transition-all duration-300">
                        <i data-lucide="home" class="icon w-6 h-6"></i>
                    </div>
                    <!-- النص يظهر فقط عندما لا يكون الزر نشطاً -->
                    <span class="nav-text text-xs mt-1">الرئيسية</span>
                </button>

                <!-- زر البطاقات -->
                <button class="nav-item flex items-center p-0 text-gray-400" onclick="navigate('cards', this)">
                    <!-- الحاوية الخضراء أو الرمادية -->
                    <div class="bg-active rounded-xl p-4 transition-all duration-300">
                        <i data-lucide="credit-card" class="icon w-6 h-6"></i>
                    </div>
                    <!-- النص يظهر فقط عندما لا يكون الزر نشطاً -->
                    <span class="nav-text text-xs mt-1">البطاقات</span>
                </button>

                <!-- زر الملف الشخصي -->
                <button class="nav-item flex items-center p-0 text-gray-400" onclick="navigate('profile', this)">
                    <!-- الحاوية الخضراء أو الرمادية -->
                    <div class="bg-active rounded-xl p-4 transition-all duration-300">
                        <i data-lucide="user" class="icon w-6 h-6"></i>
                    </div>
                    <!-- النص يظهر فقط عندما لا يكون الزر نشطاً -->
                    <span class="nav-text text-xs mt-1">الملف الشخصي</span>
                </button>
            </div>
        </nav>

    </div>

    <!-- جلب الأيقونات بعد تحميل DOM ومنطق التطبيق -->
    <script>
        
        // جلب العناصر الثابتة في الهيكل الجديد للـ Header
        const headerTitle = document.getElementById('header-title');
        const headerLeftActions = document.getElementById('header-left-actions');
        const headerRightActions = document.getElementById('header-right-actions');
        const contentArea = document.getElementById('content');
        const navItems = document.querySelectorAll('.nav-item');
        const htmlElement = document.querySelector('html'); 

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // عند التحميل، نمرر الزر الأول كمرجع (لأنه النشط افتراضياً)
            const initialButton = document.querySelector('.nav-item.active');
            navigate('home', initialButton, true); 
        });

        // ----------------------------------------------------------------------
        // بيانات المستخدم الافتراضية
        // ----------------------------------------------------------------------
        const userData = {
            name: "بركاني أمياس", // الاسم بالعربية (غير قابل للتعديل هنا)
            englishName: "BERKANI AMAYAS",
            university: "جامعة بجاية",
            birthDate: "04-12-2005",
            birthPlace: "بجاية",
            major: "علوم الطبيعة والحياة",
            year: "2025/2026",
            residenceInfo: "برشيش 3 - القسم: بجاية - الجناح والغرفة: 4-203", // بيانات بطاقة الإقامة
            matricule: "UN0601202525353025418",
            idCardImage: "https://placehold.co/40x40/00A381/ffffff?text=U", // رابط الصورة الشخصية الافتراضي
            studentCardBackground: null, 
            residenceCardBackground: null, 
            currentCardType: 'student', // الافتراضي هو بطاقة الطالب
            currentLanguage: 'ar-DZ', // اللغة الافتراضية (العربية)
            imageInputsVisible: true // حالة إظهار/إخفاء حقول الصور في شاشة البطاقات
        };
        
        // ** قاموس الترجمة **
        const translations = {
            'ar-DZ': {
                'portal_title': 'بوابة الطالب',
                'nav_home': 'الرئيسية',
                'nav_cards': 'البطاقات',
                'nav_profile': 'الملف الشخصي',
                'profile_title': 'الملف الشخصي',
                'birth_place_label': 'مكان الميلاد (Place of Birth)',
                'birth_date_label': 'تاريخ الميلاد (Date of Birth)',
                'language_switch_label': 'تغيير اللغة (Change Language)',
                'edit_info_button': 'تعديل المعلومات',
                'edit_modal_title': 'تعديل بيانات الملف الشخصي',
                'edit_english_name_label': 'الاسم بالإنجليزية',
                'edit_birth_place_label': 'مكان الميلاد',
                'edit_birth_date_label': 'تاريخ الميلاد',
                'save_button': 'حفظ التغييرات',
                'cancel_button': 'إلغاء',
                'logout_button': 'تسجيل الخروج',
                'university_name': 'وزارة التعليم العالي والبحث العلمي',
                'university_name_profile': 'جامعة بجاية',
                'student_card_button': 'بطاقة الطالب',
                'residence_card_button': 'بطاقة الإقامة',
                'remove_background': 'إزالة الخلفية',
                'change_profile_image': 'تغيير الصورة الشخصية:',
                'note_image_shared': 'ملاحظة: الصورة المستخدمة في جميع البطاقات.',
                'change_student_bg': 'تغيير خلفية بطاقة الطالب:',
                'note_student_bg': 'ستظهر كخلفية لبطاقة الطالب.',
                'change_residence_bg': 'تغيير خلفية بطاقة الإقامة:',
                'note_residence_bg': 'ستظهر كخلفية لبطاقة الإقامة.',
                'customization_title': 'أدوات التخصيص (Customize Tools)',
                'show_inputs': 'إظهار حقول التخصيص',
                'hide_inputs': 'إخفاء حقول التخصيص',
                'success': 'نجاح',
                'save_success_message': 'تم حفظ معلومات الملف الشخصي بنجاح.',
                
                // تحديث نصوص الأزرار لتتناسب مع الصورة المرفقة
                'tile_discharge': 'كشف النقاط',
                'tile_timetable': 'جدول التوقيت',
                'tile_group_section': 'المجموعة والفوج',
                'tile_exams_schedule': 'جدول الامتحانات',
                'tile_exam_grades': 'نقاط الامتحانات',
                'tile_assessment': 'التقييم',
                'tile_percentage': 'النسبة المئوية (%)',
                'tile_academic_transcripts': 'الوثائق الأكاديمية',
                'tile_debts': 'الديون',
                'tile_academic_vacation': 'عطلة أكاديمية',
                'tile_enrollments': 'التسجيلات',
                'tile_restauration': 'الإطعام',
                'tile_other_services': 'خدمات أخرى',
                
                // نصوص البطاقات
                'card_student_id': 'بطاقة الطالب',
                'card_residence_id': 'بطاقة الإقامة الجامعية',
                'card_screen_title': 'البطاقات', // العنوان الثابت لشاشة البطاقات
            },
            'en-US': { // تم تغيير المفتاح من fr-DZ إلى en-US
                'portal_title': 'Student Portal',
                'nav_home': 'Home',
                'nav_cards': 'Cards',
                'nav_profile': 'Profile',
                'profile_title': 'Profile',
                'birth_place_label': 'Place of Birth (مكان الميلاد)',
                'birth_date_label': 'Date of Birth (تاريخ الميلاد)',
                'language_switch_label': 'Change Language (تغيير اللغة)',
                'edit_info_button': 'Edit Information',
                'edit_modal_title': 'Edit Profile Data',
                'edit_english_name_label': 'Name in English',
                'edit_birth_place_label': 'Place of Birth',
                'edit_birth_date_label': 'Date of Birth',
                'save_button': 'Save Changes',
                'cancel_button': 'Cancel',
                'logout_button': 'LOGOUT',
                'university_name': 'Ministry of Higher Education and Scientific Research',
                'university_name_profile': 'University of Bejaia',
                'student_card_button': 'Student Card',
                'residence_card_button': 'Residence Card',
                'remove_background': 'Remove Background',
                'change_profile_image': 'Change Profile Picture:',
                'note_image_shared': 'Note: The image is used for all cards.',
                'change_student_bg': 'Change Student Card Background:',
                'note_student_bg': 'Will appear as background for the student card.',
                'change_residence_bg': 'Change Residence Card Background:',
                'note_residence_bg': 'Will appear as background for the residence card.',
                'customization_title': 'Customize Tools',
                'show_inputs': 'Show Customization Fields',
                'hide_inputs': 'Hide Customization Fields',
                'success': 'Success',
                'save_success_message': 'Profile information saved successfully.',

                // تحديث نصوص الأزرار لتتناسب مع الصورة المرفقة
                'tile_discharge': 'Transcripts',
                'tile_timetable': 'Timetable',
                'tile_group_section': 'Group and Section',
                'tile_exams_schedule': 'Exams Schedule',
                'tile_exam_grades': 'Exam Grades',
                'tile_assessment': 'Assessment',
                'tile_percentage': 'Percentage (%)',
                'tile_academic_transcripts': 'Academic Transcripts',
                'tile_debts': 'Debts',
                'tile_academic_vacation': 'Academic Vacation',
                'tile_enrollments': 'Enrollments',
                'tile_restauration': 'Restoration',
                'tile_other_services': 'Other Services',
                
                // نصوص البطاقات
                'card_student_id': 'Student ID Card',
                'card_residence_id': 'University Residence Card',
                'card_screen_title': 'My Card', // العنوان الثابت لشاشة البطاقات
            }
        };

        /**
         * دالة جلب النص المترجم
         * @param {string} key - مفتاح النص في القاموس
         */
        function t(key) {
            return translations[userData.currentLanguage][key] || key;
        }

        // ----------------------------------------------------------------------
        // منطق تبديل اللغة (Language Toggle Logic)
        // ----------------------------------------------------------------------
        
        /**
         * دالة لتبديل اللغة وتحديث اتجاه الواجهة بالكامل
         */
        function toggleLanguage() {
            // 1. التبديل بين العربية (ar-DZ) والإنجليزية (en-US)
            if (userData.currentLanguage === 'ar-DZ') {
                userData.currentLanguage = 'en-US';
                htmlElement.setAttribute('lang', 'en');
                htmlElement.setAttribute('dir', 'ltr');
                document.getElementById('app').classList.add('text-left');
                document.getElementById('app').classList.remove('text-right');
            } else {
                userData.currentLanguage = 'ar-DZ';
                htmlElement.setAttribute('lang', 'ar');
                htmlElement.setAttribute('dir', 'rtl');
                document.getElementById('app').classList.add('text-right');
                document.getElementById('app').classList.remove('text-left');
            }

            // 2. إعادة عرض الصفحة النشطة حالياً 
            const activeNavButton = document.querySelector('.nav-item.active');
            let screen = 'profile'; // افتراضياً الملف الشخصي
            if (activeNavButton) {
                // استخلاص اسم الشاشة من دالة navigate
                const match = activeNavButton.getAttribute('onclick').match(/'([^']*)'/);
                if (match) screen = match[1];
            }
            
            navigate(screen, activeNavButton);
        }
        
        // ----------------------------------------------------------------------
        // منطق تعديل الملف الشخصي (Profile Edit Logic)
        // ----------------------------------------------------------------------

        /**
         * دالة لفتح نافذة التعديل (Modal)
         */
        function openEditProfileModal() {
            // إزالة أي مودال سابق
            const existingModal = document.getElementById('editProfileModal');
            if (existingModal) existingModal.remove();

            const isRTL = userData.currentLanguage === 'ar-DZ';
            const directionClass = isRTL ? 'text-right' : 'text-left';

            // تحويل التاريخ من DD-MM-YYYY إلى YYYY-MM-DD لصالح حقل input type="date"
            const dateForInput = userData.birthDate.split('-').reverse().join('-');

            // إنشاء مودال HTML بسيط
            const modalHtml = `
                <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl transition-all duration-300 transform scale-95 opacity-0" id="editModalContent" dir="${isRTL ? 'rtl' : 'ltr'}">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 ${directionClass}">${t('edit_modal_title')}</h3>
                        
                        <div class="space-y-4">
                            <!-- الاسم بالإنجليزية -->
                            <div class="${directionClass}">
                                <label for="inputEnglishName" class="block text-sm font-medium text-gray-700">${t('edit_english_name_label')}</label>
                                <input type="text" id="inputEnglishName" value="${userData.englishName}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-[--primary-green] focus:border-[--primary-green] sm:text-sm">
                            </div>

                            <!-- مكان الميلاد -->
                            <div class="${directionClass}">
                                <label for="inputBirthPlace" class="block text-sm font-medium text-gray-700">${t('edit_birth_place_label')}</label>
                                <input type="text" id="inputBirthPlace" value="${userData.birthPlace}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-[--primary-green] focus:border-[--primary-green] sm:text-sm">
                            </div>

                            <!-- تاريخ الميلاد -->
                            <div class="${directionClass}">
                                <label for="inputBirthDate" class="block text-sm font-medium text-gray-700">${t('edit_birth_date_label')}</label>
                                <input type="date" id="inputBirthDate" value="${dateForInput}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-[--primary-green] focus:border-[--primary-green] sm:text-sm">
                            </div>
                        </div>

                        <div class="flex ${isRTL ? 'justify-end space-x-2 space-x-reverse' : 'justify-start space-x-2'} mt-6">
                            <button onclick="saveProfileChanges()" class="bg-[--primary-green] text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition">
                                ${t('save_button')}
                            </button>
                            <button onclick="document.getElementById('editProfileModal').remove()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-400 transition">
                                ${t('cancel_button')}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // تطبيق تأثير الظهور
            setTimeout(() => {
                const modalContent = document.getElementById('editModalContent');
                if(modalContent) {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }
            }, 10);
        }

        /**
         * دالة لحفظ التغييرات في بيانات المستخدم
         */
        function saveProfileChanges() {
            const englishName = document.getElementById('inputEnglishName').value;
            const birthPlace = document.getElementById('inputBirthPlace').value;
            const birthDateISO = document.getElementById('inputBirthDate').value;

            // تحويل تاريخ ISO إلى صيغة DD-MM-YYYY
            let birthDateDisplay = userData.birthDate;
            if (birthDateISO) {
                const dateParts = birthDateISO.split('-'); // [YYYY, MM, DD]
                birthDateDisplay = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; // DD-MM-YYYY
            }


            // تحديث البيانات
            userData.englishName = englishName.toUpperCase();
            userData.birthPlace = birthPlace;
            userData.birthDate = birthDateDisplay;

            // إغلاق المودال
            const modal = document.getElementById('editProfileModal');
            if (modal) modal.remove();

            // إعادة عرض صفحة الملف الشخصي بالبيانات الجديدة
            const activeNavButton = document.querySelector('.nav-item.active');
            navigate('profile', activeNavButton);
            
            displayCustomMessage(
                t('success'),
                t('save_success_message'),
                'check-circle'
            );
        }

        // ----------------------------------------------------------------------
        // منطق إخفاء/إظهار حقول الصور (Toggle Image Inputs Logic)
        // ----------------------------------------------------------------------

        /**
         * دالة لإخفاء أو إظهار حقول إدخال الصور والخلفيات
         * @param {boolean} show - إذا كانت true يتم الإظهار، وإذا كانت false يتم الإخفاء
         */
        function toggleImageInputs(show) {
            userData.imageInputsVisible = show;
            
            const imageInputsContainer = document.getElementById('imageInputsContainer');
            const showBtn = document.getElementById('showBtn');
            const hideBtn = document.getElementById('hideBtn');

            if (!imageInputsContainer || !showBtn || !hideBtn) return;
            
            if (show) {
                // الإظهار
                imageInputsContainer.style.display = 'block'; // استخدم block ليتناسب مع space-y
                hideBtn.classList.remove('bg-blue-500', 'text-white');
                hideBtn.classList.add('bg-gray-200', 'text-gray-600');
                showBtn.classList.add('bg-blue-500', 'text-white');
                showBtn.classList.remove('bg-gray-200', 'text-gray-600');
            } else {
                // الإخفاء
                imageInputsContainer.style.display = 'none';
                hideBtn.classList.add('bg-blue-500', 'text-white');
                hideBtn.classList.remove('bg-gray-200', 'text-gray-600');
                showBtn.classList.remove('bg-blue-500', 'text-white');
                showBtn.classList.add('bg-gray-200', 'text-gray-600');
            }
        }
        
        // ----------------------------------------------------------------------
        // منطق التمرير والتقليب (Swipe & Flip Logic)
        // ----------------------------------------------------------------------
        
        /**
         * دالة لتحديد البطاقة التالية/السابقة بناءً على التمرير
         * @param {string} direction - 'left' (يمين إلى يسار) أو 'right' (يسار إلى يمين)
         */
        function switchCard(direction) {
            let newCardType = userData.currentCardType;
            const isRTL = htmlElement.getAttribute('dir') === 'rtl';

            if (isRTL) {
                // RTL (العربية): السحب لليسار هو التالي (من الطالب إلى الإقامة)، لليمين هو السابق
                if (userData.currentCardType === 'student' && direction === 'left') {
                    newCardType = 'residence';
                } else if (userData.currentCardType === 'residence' && direction === 'right') {
                    newCardType = 'student';
                }
            } else {
                // LTR (الإنجليزية): السحب لليمين هو التالي، لليسار هو السابق
                if (userData.currentCardType === 'student' && direction === 'right') {
                    newCardType = 'residence';
                } else if (userData.currentCardType === 'residence' && direction === 'left') {
                    newCardType = 'student';
                }
            }
            
            // إذا تغير نوع البطاقة، قم بعرضها
            if (newCardType !== userData.currentCardType) {
                displayCard(newCardType);
            }
        }
        
        /**
         * تهيئة كشف الإيماءات (Gestures) على عنصر محدد
         * @param {HTMLElement} element - العنصر المراد تفعيل التمرير عليه
         */
        function setupSwipeDetection(element) {
            let startX = 0;
            let endX = 0;
            const threshold = 50; // الحد الأدنى للمسافة (بالبيكسل) لاحتسابها كسحب

            // عند بدء اللمس
            element.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                endX = startX; // إعادة تعيين
            }, { passive: true }); // استخدام passive: true لتحسين الأداء

            // عند نهاية اللمس
            element.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;

                const deltaX = startX - endX; // موجب إذا كان السحب من اليمين إلى اليسار (Swipe Left)

                if (Math.abs(deltaX) > threshold) {
                    if (deltaX > 0) {
                        // السحب من اليمين إلى اليسار (Swipe Left)
                        switchCard('left'); 
                    } else {
                        // السحب من اليسار إلى اليمين (Swipe Right)
                        switchCard('right');
                    }
                }
                // إعادة تعيين
                startX = 0;
                endX = 0;
            }, { passive: true });
        }


        // ----------------------------------------------------------------------
        // الدوال الأساسية (Navigation and Utilities)
        // ----------------------------------------------------------------------
        
        // دالة التنقل بين الشاشات
        function navigate(screen, clickedButton, isInitialLoad = false) {
            
            // 1. تحديث حالة الأزرار في القائمة السفلية
            navItems.forEach(item => {
                // إزالة فئة 'active' من الجميع
                item.classList.remove('active');
                
                // إعادة الأيقونات إلى وضعها الافتراضي
                const iconContainer = item.querySelector('.bg-active');
                const textSpan = item.querySelector('.nav-text');
                
                if (iconContainer) {
                    // التنسيق الافتراضي: دائري و p-3
                    iconContainer.classList.remove('rounded-xl', 'p-4');
                    iconContainer.classList.add('rounded-full', 'p-3');
                }
                if (textSpan) {
                     textSpan.style.display = 'block'; // إظهار النص
                }

                const icon = item.querySelector('.icon');
                if (icon) {
                    icon.style.color = '#a0aec0'; // لون الرمادي الافتراضي
                }
            });
            
            // تفعيل الزر الحالي
            if (clickedButton) {
                clickedButton.classList.add('active');
                
                // تطبيق التنسيق النشط (مربع وزوايا كبيرة و p-4)
                const activeIconContainer = clickedButton.querySelector('.bg-active');
                const activeTextSpan = clickedButton.querySelector('.nav-text');
                const activeIcon = clickedButton.querySelector('.icon');
                
                if (activeIconContainer) {
                    activeIconContainer.classList.remove('rounded-full', 'p-3');
                    activeIconContainer.classList.add('rounded-xl', 'p-4');
                }
                if (activeTextSpan) {
                     activeTextSpan.style.display = 'none'; // إخفاء النص
                }
                if (activeIcon) {
                    activeIcon.style.color = '#ffffff'; // لون الأيقونة النشطة أبيض
                }
            }


            // 2. مسح المحتوى الحالي وعرض المحتوى حسب الشاشة
            contentArea.innerHTML = '';

            if (screen === 'home') {
                renderHome();
            } else if (screen === 'cards') {
                renderCards();
            } else if (screen === 'profile') {
                renderProfile();
            }

            // 3. تحديث محتوى شريط العنوان بناءً على الشاشة
            updateHeaderContent(screen);

            // 4. إعادة إنشاء أيقونات Lucide
            lucide.createIcons();
            
            // 5. تحديث النصوص في شريط التنقل السفلي
            updateNavText();
        }

        /**
         * دالة لتحديث محتوى شريط العنوان (Header) بناءً على الشاشة
         * @param {string} screen - الشاشة الحالية ('home', 'cards', 'profile')
         */
        function updateHeaderContent(screen) {
            const isRTL = userData.currentLanguage === 'ar-DZ';
            
            // إعادة ضبط الأجزاء
            headerLeftActions.innerHTML = '';
            headerRightActions.innerHTML = '';
            // إزالة فئات المحاذاة الشائعة لإعادة تطبيقها بناءً على الشاشة
            headerTitle.classList.remove('text-center', 'text-right', 'text-left', 'flex-grow');
            
            // صورة الملف الشخصي
            const profileImageHtml = `
                <img id="profileImageHeader" 
                     src="${userData.idCardImage}" 
                     onerror="this.src='https://placehold.co/40x40/00A381/ffffff?text=U'" 
                     alt="${isRTL ? 'ملف شخصي' : 'Profile'}" 
                     class="rounded-full w-10 h-10 object-cover border-2 border-[--primary-green]">
            `;

            if (screen === 'cards') {
                // شريط البطاقات: العنوان "البطاقات" في المنتصف فقط، بدون أزرار جانبية
                
                // 1. العنوان المركزي: اسم الشاشة الثابت
                headerTitle.textContent = t('card_screen_title'); // "البطاقات"
                headerTitle.classList.add('text-center', 'flex-grow');

                // 2. مسح الإجراءات الجانبية تمامًا
                headerLeftActions.innerHTML = '';
                headerRightActions.innerHTML = '';

            } else {
                // الشاشة الرئيسية والملف الشخصي: [Title] - [Profile Image] (الأصلي)
                
                // 1. العنوان
                headerTitle.textContent = screen === 'home' ? t('portal_title') : t('nav_profile');
                headerTitle.classList.add('flex-grow');
                
                if (isRTL) {
                    // RTL: (Left-Action: Profile) | (Center-Title: Aligned Right) | (Right-Action: Empty)
                    headerTitle.classList.add('text-right');
                    headerLeftActions.innerHTML = profileImageHtml;
                    headerRightActions.innerHTML = '';
                } else {
                    // LTR: (Left-Action: Empty) | (Center-Title: Aligned Left) | (Right-Action: Profile)
                    headerTitle.classList.add('text-left');
                    headerLeftActions.innerHTML = '';
                    headerRightActions.innerHTML = profileImageHtml;
                }
            }
            
            lucide.createIcons(); // لتفعيل أي أيقونات جديدة
        }
        
        // دالة مساعدة لتحديث نصوص شريط التنقل
        function updateNavText() {
             document.querySelector('button[onclick*="\'home\'"] .nav-text').textContent = t('nav_home');
             document.querySelector('button[onclick*="\'cards\'"] .nav-text').textContent = t('nav_cards');
             document.querySelector('button[onclick*="\'profile\'"] .nav-text').textContent = t('nav_profile');
        }

        /**
         * دالة لعرض رسالة مخصصة (تحل محل alert)
         */
        function displayCustomMessage(title, message, iconName) {
            // إزالة أي مودال سابق لضمان عرض واحد فقط
            const existingModal = document.getElementById('customModal');
            if (existingModal) existingModal.remove();

            // تحديد اللغة والاتجاه
            const isRTL = userData.currentLanguage === 'ar-DZ';
            const confirmText = isRTL ? 'حسناً' : 'OK';

            // إنشاء مودال HTML بسيط
            const modalHtml = `
                <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onclick="document.getElementById('customModal').remove()">
                    <div class="bg-white rounded-xl p-6 max-w-xs w-full shadow-2xl" onclick="event.stopPropagation()" dir="${isRTL ? 'rtl' : 'ltr'}">
                        <div class="flex items-center justify-between mb-4 border-b pb-2">
                            <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                            <i data-lucide="${iconName}" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <p class="text-gray-700 whitespace-pre-line">${message}</p>
                        <button class="w-full mt-6 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition" onclick="document.getElementById('customModal').remove()">
                            ${confirmText}
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            lucide.createIcons();
        }


        // ----------------------------------------------------------------------
        // 1. شاشة الرئيسية (Home Screen)
        // ----------------------------------------------------------------------
        function renderHome() {
            // قائمة الأزرار المطابقة للصورة المرفقة
            const tiles = [
                { titleKey: 'tile_discharge', icon: 'file-text' },
                { titleKey: 'tile_timetable', icon: 'calendar' },
                { titleKey: 'tile_group_section', icon: 'users' },
                { titleKey: 'tile_exams_schedule', icon: 'calendar-check' },
                { titleKey: 'tile_exam_grades', icon: 'graduation-cap' },
                { titleKey: 'tile_assessment', icon: 'award' },
                { titleKey: 'tile_percentage', icon: 'pie-chart' },
                { titleKey: 'tile_academic_transcripts', icon: 'folder-open' },
                { titleKey: 'tile_debts', icon: 'calculator' },
                { tileKey: 'tile_academic_vacation', icon: 'archive' },
                { titleKey: 'tile_enrollments', icon: 'book-open' },
                { titleKey: 'tile_restauration', icon: 'utensils' },
                { titleKey: 'tile_other_services', icon: 'grid' },
            ];
            
            const isRTL = userData.currentLanguage === 'ar-DZ';
            const directionClass = isRTL ? 'text-right' : 'text-left';

            const headerHtml = `
                <!-- تصميم البانر الأخضر العلوي المطابق للصورة -->
                <div class="bg-[--primary-green] rounded-2xl p-4 shadow-lg mb-4 text-center">
                    <!-- PROGRES Logo مع محاذاة في الوسط -->
                    <div class="flex flex-col items-center justify-center space-y-2">
                        <!-- الشعار نفسه (تم استخدام placeholder بألوان متقاربة) -->
                        <img src="https://placehold.co/150x30/10B981/ffffff?text=PROGRES" alt="PROGRES Logo" class="h-6" onerror="this.src='https://placehold.co/150x30/10B981/ffffff?text=PROGRES'">
                        <p class="text-white text-xs font-light tracking-wide">${t('university_name')}</p>
                    </div>
                </div>
            `;

            // تصميم الخانة (Tile) ليناسب الشكل الموضح في الصورة
            const tilesHtml = tiles.map(tile => `
                <button class="
                    bg-[--tile-bg] 
                    text-white 
                    rounded-2xl 
                    p-3 
                    flex 
                    flex-col 
                    items-center 
                    justify-center 
                    text-center 
                    shadow-lg 
                    transition 
                    duration-150 
                    ease-in-out 
                    h-24 
                    w-full 
                    hover:bg-green-700 
                    active:bg-green-800
                ">
                    <!-- الأيقونة يتم استخدامها مع Lucide -->
                    <i data-lucide="${tile.icon}" class="w-6 h-6 mb-1"></i>
                    <!-- النص باللون الأبيض وحجم أصغر -->
                    <span class="text-sm font-medium leading-tight">${t(tile.titleKey)}</span>
                </button>
            `).join('');

            contentArea.innerHTML = `
                ${headerHtml}
                <!-- الشبكة (Grid) 2x2 مع مسافة واسعة بين الخانات (gap-4) -->
                <div class="grid grid-cols-2 gap-4 pb-4">
                    ${tilesHtml}
                </div>
            `;

            // إزالة فئات توسيط البطاقة لصفحة الرئيسية
            contentArea.classList.remove('flex', 'flex-col', 'items-center', 'justify-start');
            contentArea.classList.add('p-4', 'space-y-4');
        }

        // ----------------------------------------------------------------------
        // 2. شاشة البطاقات (Cards Screen)
        // ----------------------------------------------------------------------
        function renderCards() {
            // إضافة فئات التوسيط للبطاقة وجعلها تبدأ من الأعلى
            contentArea.classList.add('flex', 'flex-col', 'items-center', 'justify-start');
            contentArea.classList.remove('p-4', 'space-y-4'); 

            const isRTL = userData.currentLanguage === 'ar-DZ';
            
            const cardsHtml = `
                <div class="w-full max-w-sm p-4 space-y-4">
                    
                    <!-- حاوية عرض البطاقة -->
                    <div id="cardDisplayArea" class="w-full flex justify-center py-4 transition-opacity duration-300">
                        <!-- سيتم تحميل البطاقة هنا بواسطة displayCard() -->
                    </div>

                    <div class="p-4 text-center text-gray-500 text-sm">
                        <!-- تذكير للمستخدم بكيفية التبديل -->
                        <i data-lucide="chevrons-left-right" class="w-5 h-5 inline-block ${isRTL ? 'ml-2' : 'mr-2'}"></i>
                        <span>${isRTL ? 'اسحب البطاقة لليمين أو اليسار للتبديل' : 'Swipe card left or right to switch'}</span>
                    </div>

                </div>
            `;

            contentArea.innerHTML = cardsHtml;

            // عرض البطاقة الافتراضية (بطاقة الطالب)
            displayCard(userData.currentCardType, true);
            
            // **تفعيل كشف التمرير على منطقة عرض البطاقة**
            const cardDisplayArea = document.getElementById('cardDisplayArea');
            if (cardDisplayArea) {
                setupSwipeDetection(cardDisplayArea);
            }
            
            // يجب إعادة إنشاء الأيقونات للتأكد من ظهورها
            lucide.createIcons();
        }

        /**
         * دالة مساعدة لمعالجة رفع الخلفية وتخزينها في المتغير الصحيح
         * @param {Event} event - حدث الرفع
         * @param {string} type - 'student' أو 'residence'
         */
        function handleBackgroundUpload(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (type === 'student') {
                        userData.studentCardBackground = e.target.result;
                    } else if (type === 'residence') {
                        userData.residenceCardBackground = e.target.result;
                    }
                    // إعادة عرض البطاقة لتطبيق الخلفية الجديدة على البطاقة الحالية
                    const activeNavButton = document.querySelector('.nav-item.active');
                    if (activeNavButton.getAttribute('onclick').includes('cards')) {
                         displayCard(userData.currentCardType);
                    }
                   
                };
                reader.readAsDataURL(file);
            }
        }

        /**
         * دالة لإزالة الخلفية المضافة لبطاقة معينة
         * @param {string} type - 'student' أو 'residence'
         */
        function removeCardBackground(type) {
            if (type === 'student') {
                userData.studentCardBackground = null;
            } else if (type === 'residence') {
                userData.residenceCardBackground = null;
            }
            // تحديث العرض إذا كانت البطاقة التي تم إزالة خلفيتها هي البطاقة المعروضة حاليًا
            const activeNavButton = document.querySelector('.nav-item.active');
            if (activeNavButton.getAttribute('onclick').includes('cards') && userData.currentCardType === type) {
                displayCard(userData.currentCardType);
            }
        }

        /**
         * دالة لعرض تصميم بطاقة معين (بطاقة الطالب أو الإقامة) مع تأثير الحركة
         * @param {string} type - 'student' أو 'residence'
         * @param {boolean} skipAnimation - لتخطي الحركة عند تحميل الشاشة لأول مرة
         */
        function displayCard(type, skipAnimation = false) {
            const cardDisplayArea = document.getElementById('cardDisplayArea');
            if (!cardDisplayArea) return;

            // تحديد حاوية التقليب
            let flipper = document.getElementById('idCardFlipper');
            
            // 1. إذا كانت هذه هي المرة الأولى، نقوم بإنشاء الهيكل الأساسي للتقليب
            if (!flipper) {
                cardDisplayArea.innerHTML = `
                    <div class="id-card-container">
                        <div id="idCardFlipper" class="id-card-flipper">
                            <!-- البطاقة الأمامية (طالب) -->
                            <div id="studentCard" class="card-face front bg-white rounded-2xl"></div>
                            <!-- البطاقة الخلفية (إقامة) -->
                            <div id="residenceCard" class="card-face back bg-white rounded-2xl"></div>
                        </div>
                    </div>
                `;
                flipper = document.getElementById('idCardFlipper');
            }
            
            // 2. تحديث المحتوى الداخلي للبطاقتين (لتجنب الوميض)
            updateCardContent('student', document.getElementById('studentCard'));
            updateCardContent('residence', document.getElementById('residenceCard'));
            
            // 3. تطبيق الحركة
            if (!skipAnimation && type !== userData.currentCardType) {
                // إذا كانت البطاقة المطلوبة هي الإقامة، نقوم بالتقليب إلى 180 (إظهار الظهر)
                if (type === 'residence') {
                    flipper.classList.add('is-flipping');
                } else {
                    // إذا كانت البطاقة المطلوبة هي الطالب، نقوم بالتقليب إلى 0 (إظهار الوجه)
                    flipper.classList.remove('is-flipping');
                }
            } else if (skipAnimation) {
                 // إذا كان تحميل أولي، نضمن أن الحالة صحيحة بدون حركة
                 if (type === 'residence') {
                    flipper.classList.add('is-flipping');
                } else {
                    flipper.classList.remove('is-flipping');
                }
            }
            
            // 4. تحديث حالة نوع البطاقة الحالية بعد اكتمال الحركة
            setTimeout(() => {
                 userData.currentCardType = type;
                 
                 // ** تحديث عنوان الهيدر (لا يتغير في شاشة البطاقات)
                 // لكن هذه الوظيفة تبقى هنا تحسبا لأي توسع مستقبلي يتطلب تحديث
                 const currentScreen = document.querySelector('.nav-item.active').getAttribute('onclick').match(/'([^']*)'/)[1];
                 if (currentScreen === 'cards') {
                     updateHeaderContent('cards');
                 }
                 
            }, skipAnimation ? 0 : 600); // 600ms هي مدة الحركة

            lucide.createIcons(); // لإنشاء أي أيقونات جديدة داخل البطاقة
        }

        /**
         * دالة مساعدة لتوليد محتوى بطاقة الطالب أو الإقامة (فارغة)
         */
        function updateCardContent(type, cardElement) {
            
            const isStudent = type === 'student';
            const cardBackground = isStudent 
                ? userData.studentCardBackground 
                : userData.residenceCardBackground;
            
            // تحديد لون الخلفية الافتراضي إذا لم تكن هناك صورة
            const defaultBgColor = isStudent ? '#ffffff' : '#fffbe7'; // أبيض للطالب، وأصفر فاتح للإقامة

            // تطبيق الخلفية المخصصة أو تركها فارغة
            if (cardBackground) {
                cardElement.style.backgroundImage = `url('${cardBackground}')`;
                cardElement.style.backgroundSize = 'cover';
                cardElement.style.backgroundPosition = 'center';
                cardElement.style.backgroundColor = 'transparent';
            } else {
                cardElement.style.backgroundImage = 'none';
                cardElement.style.backgroundColor = defaultBgColor;
            }
            
            // المحتوى الفارغ تماماً
            const content = `
                <div class="relative z-20 w-full h-full">
                    <!-- محتوى البطاقة فارغ تماماً -->
                </div>
                <!-- طبقة التعتيم تبقى موجودة إذا كانت هناك خلفية مخصصة -->
                ${cardBackground ? '<div class="card-overlay opacity-20"></div>' : ''}
                <!-- نمط النقاط الخفيف يبقى للخلفية البيضاء الافتراضية لتبدو كبطاقة ورقية -->
                ${cardBackground ? '' : '<div class="absolute inset-0 bg-repeat opacity-5" style="background-image: radial-gradient(#efefef 1px, transparent 1px); background-size: 8px 8px;"></div>'}
            `;

            cardElement.innerHTML = content;
        }

        // ----------------------------------------------------------------------
        // 3. شاشة الملف الشخصي (Profile Screen) 
        // ----------------------------------------------------------------------
        function renderProfile() {
            const isRTL = userData.currentLanguage === 'ar-DZ';
            
            // تحديث الصورة في الهيدر
            const profileImageHeader = document.getElementById('profileImageHeader');
            if (profileImageHeader) profileImageHeader.src = userData.idCardImage;
            
            // تحديد اتجاه النص والحاويات
            const directionClass = isRTL ? 'text-right' : 'text-left';
            const itemMarginClass = isRTL ? 'ml-4' : 'mr-4'; // عكس الهامش الجانبي
            
            // التعديلات هنا: إضافة زر تعديل المعلومات
            const profileHtml = `
                <!-- بطاقة الاسم والجامعة (الخضراء) -->
                <div class="bg-[--primary-green] rounded-2xl p-4 flex items-center shadow-lg mb-4 text-white ${isRTL ? '' : 'flex-row-reverse'}">
                    <img id="profileImageCard" src="${userData.idCardImage}" alt="${isRTL ? 'صورة المستخدم' : 'User Image'}" class="w-14 h-14 rounded-full object-cover border-2 border-white ${itemMarginClass}">
                    <div class="${directionClass} flex-grow">
                        <!-- الاسم بالإنجليزية ثابت -->
                        <p class="text-lg font-bold">${userData.englishName}</p>
                        <!-- الجامعة يتم ترجمتها -->
                        <p class="text-sm font-light">${t('university_name_profile')}</p>
                    </div>
                </div>

                <!-- زر تعديل المعلومات -->
                <button onclick="openEditProfileModal()" class="w-full bg-blue-500 text-white p-3 rounded-2xl font-bold text-base shadow-lg hover:bg-blue-600 transition duration-150 mb-4 flex items-center justify-center">
                    <i data-lucide="edit" class="w-5 h-5 inline-block ${isRTL ? 'ml-2' : 'mr-2'}"></i>
                    ${t('edit_info_button')}
                </button>

                <!-- بطاقة مكان الميلاد -->
                <div class="bg-white rounded-2xl p-4 flex items-start space-x-3 ${isRTL ? 'space-x-reverse' : ''} shadow-md">
                    <i data-lucide="map-pin" class="w-6 h-6 text-[--primary-green] flex-shrink-0 mt-0.5"></i>
                    <div class="directionClass} flex-grow">
                        <p class="text-sm font-medium text-gray-500">${t('birth_place_label')}</p>
                        <p class="text-lg font-bold text-gray-800 mt-1">${userData.birthPlace}</p>
                    </div>
                </div>

                <!-- بطاقة تاريخ الميلاد -->
                <div class="bg-white rounded-2xl p-4 flex items-start space-x-3 ${isRTL ? 'space-x-reverse' : ''} shadow-md mt-4">
                    <i data-lucide="calendar" class="w-6 h-6 text-[--primary-green] flex-shrink-0 mt-0.5"></i>
                    <div class="directionClass} flex-grow">
                        <p class="text-sm font-medium text-gray-500">${t('birth_date_label')}</p>
                        <p class="text-lg font-bold text-gray-800 mt-1">${userData.birthDate}</p>
                    </div>
                </div>

                <!-- بطاقة تغيير اللغة -->
                <div class="bg-white rounded-2xl p-4 flex justify-between items-center shadow-md mt-4">
                    <div class="flex items-center space-x-3 ${isRTL ? 'space-x-reverse' : ''}">
                        <i data-lucide="languages" class="w-6 h-6 text-[--primary-green] flex-shrink-0"></i>
                        <p class="text-base font-medium text-gray-800">${t('language_switch_label')}</p>
                    </div>
                    <!-- الزر يستدعي دالة التبديل ويظهر اللغة الحالية -->
                    <button id="languageButton" onclick="toggleLanguage()" class="bg-[--primary-green] text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg hover:bg-green-700 transition duration-150">
                        ${userData.currentLanguage === 'ar-DZ' ? 'English' : 'العربية'}
                    </button>
                </div>
                
                <!-- ********************************************** -->
                <!-- حاوية أدوات التخصيص (تم نقلها من شاشة البطاقات) -->
                <!-- ********************************************** -->
                <div id="customizationControls" class="space-y-4 mt-6">

                     <!-- عنوان قسم الصور مع أزرار الإخفاء/الإظهار -->
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg border-b border-gray-300">
                        <h3 class="text-lg font-bold text-gray-800">${t('customization_title')}</h3>
                        <!-- الأزرار الصغيرة للإخفاء والإظهار -->
                        <div class="flex space-x-2 ${isRTL ? 'space-x-reverse' : ''}">
                            <!-- زر الإظهار -->
                            <button id="showBtn" onclick="toggleImageInputs(true)" class="toggle-btn ${userData.imageInputsVisible ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'} rounded-full hover:bg-gray-300 transition duration-150 shadow-inner" title="${t('show_inputs')}">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                            </button>
                            <!-- زر الإخفاء -->
                            <button id="hideBtn" onclick="toggleImageInputs(false)" class="toggle-btn ${!userData.imageInputsVisible ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'} rounded-full hover:bg-gray-300 transition duration-150 shadow-inner" title="${t('hide_inputs')}">
                                <i data-lucide="eye-off" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- حاوية حقول إدخال الصور التي سيتم إخفاؤها/إظهارها -->
                    <div id="imageInputsContainer" class="space-y-4" style="display: ${userData.imageInputsVisible ? 'block' : 'none'};"> 
                        <!-- خاصية رفع الصورة الشخصية (مشتركة) -->
                        <div class="bg-white p-4 rounded-xl shadow-md space-y-3">
                            <p class="text-sm font-bold text-gray-700">${t('change_profile_image')}</p>
                            <input type="file" id="imageUploader" accept="image/*" class="w-full text-sm text-gray-500 file:mr-3 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer">
                            <p class="text-xs text-gray-500 mt-2">${t('note_image_shared')}</p>
                        </div>

                        <!-- 1. خلفية بطاقة الطالب -->
                        <div class="bg-white p-4 rounded-xl shadow-md space-y-3">
                            <p class="text-sm font-bold text-gray-700">${t('change_student_bg')}</p>
                            <input type="file" id="studentBackgroundUploader" accept="image/*" class="w-full text-sm text-gray-500 file:mr-3 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 cursor-pointer">
                            <p class="text-xs text-gray-500 mt-2">${t('note_student_bg')}</p>
                            <button class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-sm hover:bg-gray-300 transition duration-150 mt-2" onclick="removeCardBackground('student')">
                                ${t('remove_background')}
                            </button>
                        </div>

                        <!-- 2. خلفية بطاقة الإقامة -->
                        <div class="bg-white p-4 rounded-xl shadow-md space-y-3">
                            <p class="text-sm font-bold text-gray-700">${t('change_residence_bg')}</p>
                            <input type="file" id="residenceBackgroundUploader" accept="image/*" class="w-full text-sm text-gray-500 file:mr-3 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 cursor-pointer">
                            <p class="text-xs text-gray-500 mt-2">${t('note_residence_bg')}</p>
                            <button class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-sm hover:bg-gray-300 transition duration-150 mt-2" onclick="removeCardBackground('residence')">
                                ${t('remove_background')}
                            </button>
                        </div>
                    </div> <!-- نهاية imageInputsContainer -->
                </div> <!-- نهاية customizationControls -->
                
                <!-- زر تسجيل الخروج -->
                <button class="w-full bg-[--logout-red] text-white p-4 rounded-2xl font-bold text-lg shadow-lg hover:bg-red-700 transition duration-150 mt-6">
                    ${t('logout_button')}
                </button>
            `;
            contentArea.innerHTML = profileHtml;
            // إزالة فئات توسيط البطاقة لصفحة الملف الشخصي
            contentArea.classList.remove('flex', 'flex-col', 'items-center', 'justify-center');
            contentArea.classList.add('p-4', 'space-y-4');
            
            // **ربط مستمعات الأحداث لرفع الصور**
            
            // منطق تحميل الصورة الشخصية (مشتركة)
            document.getElementById('imageUploader').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userData.idCardImage = e.target.result;
                        // تحديث الصورة في الهيدر والبطاقة (التي ما زالت تظهر في الهيدر)
                        const profileImageHeader = document.getElementById('profileImageHeader');
                        if(profileImageHeader) profileImageHeader.src = userData.idCardImage;
                        // تحديث الصورة في صفحة الملف الشخصي
                        const profileImageCard = document.getElementById('profileImageCard');
                        if(profileImageCard) profileImageCard.src = userData.idCardImage;
                        // إعادة عرض البطاقة لتحديث الصورة إذا كان المستخدم في شاشة البطاقات حالياً
                        const activeNavButton = document.querySelector('.nav-item.active');
                        if (activeNavButton.getAttribute('onclick').includes('cards')) {
                             displayCard(userData.currentCardType);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            // منطق تحميل خلفية بطاقة الطالب
            document.getElementById('studentBackgroundUploader').addEventListener('change', function(event) {
                handleBackgroundUpload(event, 'student');
            });

            // منطق تحميل خلفية بطاقة الإقامة
            document.getElementById('residenceBackgroundUploader').addEventListener('change', function(event) {
                handleBackgroundUpload(event, 'residence');
            });
        }

    </script>
</body>
</html>
