<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة الطالب | Student Portal</title>
    
    <!-- PWA Meta Tags (Left for basic compatibility) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#008060">
    
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل مكتبة Lucide Icons لأيقونات واجهة المستخدم -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* خط إنتر (Inter) هو خط حديث وواضح يناسب التصميم */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* لون الخلفية الفاتح */
        }
        /* إخفاء شريط التمرير (Scrollbar) في الـ body للجوال */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* الألوان والثوابت */
        :root {
            --primary-green: #008060; /* اللون الأخضر الداكن */
            --nav-bg: #2c334b; /* لون الشريط السفلي */
            --logout-red: #dc2626; /* لون الأحمر للخروج - red-600 */
        }

        /* تصميم زر القائمة السفلية */
        .nav-item .icon {
            color: #a0aec0; /* لون الرمادي الافتراضي */
            /* إضافة انتقال سلس لتغيير اللون */
            transition: color 0.3s ease-in-out; 
        }
        .nav-item .bg-active {
            /* إضافة انتقال سلس للخلفية والتظليل */
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        /* حالة النشاط (Active State) */
        .nav-item.active .icon {
            color: #ffffff;
        }
        .nav-item.active .bg-active {
            background-color: var(--primary-green);
            /* إضافة ظل خفيف للزر النشط */
            box-shadow: 0 4px 10px rgba(0, 128, 96, 0.4); 
            /* عند النشاط، نجعل الأيقونة أكبر قليلاً لإبرازها */
            transform: scale(1.05);
        }
        
        /* لضمان أن التطبيق يملأ الشاشة بالكامل على الجوالات الحديثة (بما في ذلك المساحات الآمنة) */
        .h-screen-safe {
            height: 100vh;
            height: 100svh; /* استخدام svh للأجهزة الحديثة للارتفاع الآمن */
        }

        /* تنسيق بطاقة الهوية (ID Card) */
        .id-card-container {
            /* تعديل الأبعاد لتكون عمودية (طولية) بنسبة 1:1.58 */
            width: 85vw; /* عرض أقل بقليل ليناسب التصميم الطولي */
            max-width: 300px; /* أقصى عرض معقول */
            /* الحفاظ على نسبة العرض/الارتفاع العمودية (الطول > العرض) */
            aspect-ratio: 1 / 1.58; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            
            /* ألوان الخلفية الافتراضية */
            background-color: #ffffff;
            /* إضافة خاصية للحركة السلسة عند تغيير الخلفية */
            transition: background-image 0.5s ease-in-out, background-color 0.5s ease-in-out;
            
            /* مهم: لضمان أن الصورة الخلفية تملأ الحاوية بالكامل */
            background-size: cover;
            background-position: center; 
            
            /* منع تحديد النص داخل البطاقة */
            user-select: none;
            -webkit-user-select: none;
            touch-action: pan-y; /* السماح بالتمرير العمودي فقط، والتعامل مع الأفقي بالجافاسكريبت */
        }

        /* تنسيق طبقة التعتيم على خلفية البطاقة */
        .card-overlay {
            position: absolute;
            inset: 0;
            /* لون تعتيم خفيف لضمان وضوح النص فوق الصورة */
            background-color: rgba(255, 255, 255, 0.6); 
            z-index: 5; /* يكون أعلى من الخلفية، وأسفل محتوى البطاقة */
        }

    </style>
</head>
<body class="h-screen-safe flex flex-col items-center">

    <!-- الحاوية الرئيسية للتطبيق، محددة بأقصى عرض للهاتف (max-w-md) لتبدو كالتطبيق الأصلي -->
    <div id="app" class="w-full max-w-md h-screen-safe flex flex-col bg-gray-100 overflow-hidden">

        <!-- رأس الصفحة (Header) -->
        <header id="header" class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10">
            <h1 id="header-title" class="text-xl font-bold text-gray-800">بوابة الطالب</h1>
            <!-- شعار الملف الشخصي الصغير في الركن العلوي الأيمن -->
            <img id="profileImageHeader" src="https://placehold.co/40x40/008060/ffffff?text=U" onerror="this.src='https://placehold.co/40x40/008060/ffffff?text=U'" alt="ملف شخصي" class="rounded-full w-10 h-10 object-cover border-2 border-green-600">
        </header>

        <!-- محتوى الصفحة (Content) -->
        <main id="content" class="flex-grow overflow-y-auto p-4 space-y-4">
            <!-- سيتم تحميل محتوى الشاشات هنا -->
        </main>

        <!-- قائمة التنقل السفلية (Bottom Navigation Bar) -->
        <nav class="bg-[--nav-bg] p-2">
            <div class="flex justify-around">
                <!-- زر الرئيسية -->
                <button class="nav-item flex flex-col items-center p-2 text-gray-400 active" onclick="navigate('home', this)">
                    <div class="p-3 rounded-full transition-all duration-300 bg-active">
                        <i data-lucide="home" class="icon w-6 h-6"></i>
                    </div>
                    <span class="text-xs mt-1">الرئيسية</span>
                </button>

                <!-- زر البطاقات -->
                <button class="nav-item flex flex-col items-center p-2 text-gray-400" onclick="navigate('cards', this)">
                    <div class="p-3 rounded-full transition-all duration-300 bg-active">
                        <i data-lucide="credit-card" class="icon w-6 h-6"></i>
                    </div>
                    <span class="text-xs mt-1">البطاقات</span>
                </button>

                <!-- زر الملف الشخصي -->
                <button class="nav-item flex flex-col items-center p-2 text-gray-400" onclick="navigate('profile', this)">
                    <div class="p-3 rounded-full transition-all duration-300 bg-active">
                        <i data-lucide="user" class="icon w-6 h-6"></i>
                    </div>
                    <span class="text-xs mt-1">الملف الشخصي</span>
                </button>
            </div>
        </nav>

    </div>

    <!-- جلب الأيقونات بعد تحميل DOM ومنطق التطبيق -->
    <script>
        
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // عند التحميل، نمرر الزر الأول كمرجع (لأنه النشط افتراضياً)
            const initialButton = document.querySelector('.nav-item.active');
            navigate('home', initialButton, true); 
        });

        const headerTitle = document.getElementById('header-title');
        const contentArea = document.getElementById('content');
        const navItems = document.querySelectorAll('.nav-item');
        const htmlElement = document.querySelector('html'); // للتحكم في اتجاه الصفحة

        // ----------------------------------------------------------------------
        // بيانات المستخدم الافتراضية
        // ----------------------------------------------------------------------
        const userData = {
            name: "بركاني أمياس", // الاسم بالعربية (غير قابل للتعديل هنا)
            englishName: "BERKANI AMAYAS",
            university: "جامعة بجاية",
            birthDate: "04-12-2005",
            birthPlace: "بجاية",
            major: "علوم الطبيعة والحياة",
            year: "2025/2026",
            matricule: "UN0601202525353025418",
            residenceInfo: "برشيش 3 - القسم: بجاية - الجناح والغرفة: 4-203", // بيانات بطاقة الإقامة
            idCardImage: "https://placehold.co/40x40/d4d4d4/262626?text=U", // رابط الصورة الشخصية الافتراضي
            studentCardBackground: null, 
            residenceCardBackground: null, 
            currentCardType: 'student', 
            currentLanguage: 'ar-DZ' // اللغة الافتراضية (العربية)
        };
        
        // ** قاموس الترجمة **
        const translations = {
            'ar-DZ': {
                'portal_title': 'بوابة الطالب',
                'nav_home': 'الرئيسية',
                'nav_cards': 'البطاقات',
                'nav_profile': 'الملف الشخصي',
                'profile_title': 'الملف الشخصي',
                'birth_place_label': 'مكان الميلاد (Place of Birth)',
                'birth_date_label': 'تاريخ الميلاد (Date of Birth)',
                'language_switch_label': 'تغيير اللغة (Change Language)',
                'edit_info_button': 'تعديل المعلومات',
                'edit_modal_title': 'تعديل بيانات الملف الشخصي',
                'edit_english_name_label': 'الاسم بالإنجليزية',
                'edit_birth_place_label': 'مكان الميلاد',
                'edit_birth_date_label': 'تاريخ الميلاد',
                'save_button': 'حفظ التغييرات',
                'cancel_button': 'إلغاء',
                'logout_button': 'LOGOUT',
                'university_name': 'وزارة التعليم العالي والبحث العلمي',
                'university_name_profile': 'جامعة بجاية',
                'student_card_button': 'بطاقة الطالب',
                'residence_card_button': 'بطاقة الإقامة',
                'remove_background': 'إزالة الخلفية',
                'change_profile_image': 'تغيير الصورة الشخصية:',
                'note_image_shared': 'ملاحظة: الصورة المستخدمة في جميع البطاقات.',
                'change_student_bg': 'تغيير خلفية بطاقة الطالب:',
                'note_student_bg': 'ستظهر كخلفية لبطاقة الطالب.',
                'change_residence_bg': 'تغيير خلفية بطاقة الإقامة:',
                'note_residence_bg': 'ستظهر كخلفية لبطاقة الإقامة.'
            },
            'fr-DZ': {
                'portal_title': 'Portail Étudiant',
                'nav_home': 'Accueil',
                'nav_cards': 'Cartes',
                'nav_profile': 'Profil',
                'profile_title': 'Profil',
                'birth_place_label': 'Lieu de naissance (مكان الميلاد)',
                'birth_date_label': 'Date de naissance (تاريخ الميلاد)',
                'language_switch_label': 'Changer la langue (تغيير اللغة)',
                'edit_info_button': 'Modifier les informations',
                'edit_modal_title': 'Modifier les données du profil',
                'edit_english_name_label': 'Nom en anglais',
                'edit_birth_place_label': 'Lieu de naissance',
                'edit_birth_date_label': 'Date de naissance',
                'save_button': 'Enregistrer les changements',
                'cancel_button': 'Annuler',
                'logout_button': 'DÉCONNEXION',
                'university_name': 'Ministère de l\'Enseignement Supérieur',
                'university_name_profile': 'Université de Béjaïa',
                'student_card_button': 'Carte Étudiant',
                'residence_card_button': 'Carte Résidence',
                'remove_background': 'Supprimer le fond',
                'change_profile_image': 'Changer la photo de profil:',
                'note_image_shared': 'Note: L\'image est utilisée pour toutes les cartes.',
                'change_student_bg': 'Changer le fond de la carte étudiant:',
                'note_student_bg': 'Apparaîtra comme fond pour la carte étudiant.',
                'change_residence_bg': 'Changer le fond de la carte résidence:',
                'note_residence_bg': 'Apparaîtra comme fond pour la carte résidence.'
            }
        };

        /**
         * دالة جلب النص المترجم
         * @param {string} key - مفتاح النص في القاموس
         */
        function t(key) {
            return translations[userData.currentLanguage][key] || key;
        }

        // ----------------------------------------------------------------------
        // منطق تبديل اللغة (Language Toggle Logic)
        // ----------------------------------------------------------------------
        
        /**
         * دالة لتبديل اللغة وتحديث اتجاه الواجهة بالكامل
         */
        function toggleLanguage() {
            // 1. التبديل بين العربية والفرنسية
            if (userData.currentLanguage === 'ar-DZ') {
                userData.currentLanguage = 'fr-DZ';
                htmlElement.setAttribute('lang', 'fr');
                htmlElement.setAttribute('dir', 'ltr');
                document.getElementById('app').classList.add('text-left');
                document.getElementById('app').classList.remove('text-right');
            } else {
                userData.currentLanguage = 'ar-DZ';
                htmlElement.setAttribute('lang', 'ar');
                htmlElement.setAttribute('dir', 'rtl');
                document.getElementById('app').classList.add('text-right');
                document.getElementById('app').classList.remove('text-left');
            }

            // 2. إعادة عرض الصفحة النشطة حالياً (عادةً الملف الشخصي)
            const activeNavButton = document.querySelector('.nav-item.active');
            let screen = 'profile'; // افتراضياً الملف الشخصي
            if (activeNavButton) {
                // استخلاص اسم الشاشة من دالة navigate
                const match = activeNavButton.getAttribute('onclick').match(/'([^']*)'/);
                if (match) screen = match[1];
            }
            
            navigate(screen, activeNavButton);
        }
        
        // ----------------------------------------------------------------------
        // منطق تعديل الملف الشخصي (Profile Edit Logic)
        // ----------------------------------------------------------------------

        /**
         * دالة لفتح نافذة التعديل (Modal)
         */
        function openEditProfileModal() {
            // إزالة أي مودال سابق
            const existingModal = document.getElementById('editProfileModal');
            if (existingModal) existingModal.remove();

            const isRTL = userData.currentLanguage === 'ar-DZ';
            const directionClass = isRTL ? 'text-right' : 'text-left';

            // إنشاء مودال HTML بسيط
            const modalHtml = `
                <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl transition-all duration-300 transform scale-95 opacity-0" id="editModalContent" dir="${isRTL ? 'rtl' : 'ltr'}">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 ${directionClass}">${t('edit_modal_title')}</h3>
                        
                        <div class="space-y-4">
                            <!-- الاسم بالإنجليزية -->
                            <div class="${directionClass}">
                                <label for="inputEnglishName" class="block text-sm font-medium text-gray-700">${t('edit_english_name_label')}</label>
                                <input type="text" id="inputEnglishName" value="${userData.englishName}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-[--primary-green] focus:border-[--primary-green] sm:text-sm">
                            </div>

                            <!-- مكان الميلاد -->
                            <div class="${directionClass}">
                                <label for="inputBirthPlace" class="block text-sm font-medium text-gray-700">${t('edit_birth_place_label')}</label>
                                <input type="text" id="inputBirthPlace" value="${userData.birthPlace}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-[--primary-green] focus:border-[--primary-green] sm:text-sm">
                            </div>

                            <!-- تاريخ الميلاد -->
                            <div class="${directionClass}">
                                <label for="inputBirthDate" class="block text-sm font-medium text-gray-700">${t('edit_birth_date_label')}</label>
                                <input type="date" id="inputBirthDate" value="${userData.birthDate.split('-').reverse().join('-')}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-[--primary-green] focus:border-[--primary-green] sm:text-sm">
                            </div>
                        </div>

                        <div class="flex ${isRTL ? 'justify-end space-x-2 space-x-reverse' : 'justify-start space-x-2'} mt-6">
                            <button onclick="saveProfileChanges()" class="bg-[--primary-green] text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition">
                                ${t('save_button')}
                            </button>
                            <button onclick="document.getElementById('editProfileModal').remove()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-400 transition">
                                ${t('cancel_button')}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // تطبيق تأثير الظهور
            setTimeout(() => {
                document.getElementById('editModalContent').classList.remove('scale-95', 'opacity-0');
                document.getElementById('editModalContent').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        /**
         * دالة لحفظ التغييرات في بيانات المستخدم
         */
        function saveProfileChanges() {
            const englishName = document.getElementById('inputEnglishName').value;
            const birthPlace = document.getElementById('inputBirthPlace').value;
            const birthDateISO = document.getElementById('inputBirthDate').value;

            // تحويل تاريخ ISO إلى صيغة DD-MM-YYYY
            let birthDateDisplay = userData.birthDate;
            if (birthDateISO) {
                const dateParts = birthDateISO.split('-'); // [YYYY, MM, DD]
                birthDateDisplay = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; // DD-MM-YYYY
            }


            // تحديث البيانات
            userData.englishName = englishName.toUpperCase();
            userData.birthPlace = birthPlace;
            userData.birthDate = birthDateDisplay;

            // إغلاق المودال
            document.getElementById('editProfileModal').remove();

            // إعادة عرض صفحة الملف الشخصي بالبيانات الجديدة
            const activeNavButton = document.querySelector('.nav-item.active');
            navigate('profile', activeNavButton);
            
            displayCustomMessage(
                userData.currentLanguage === 'ar-DZ' ? 'نجاح' : 'Succès',
                userData.currentLanguage === 'ar-DZ' ? 'تم حفظ معلومات الملف الشخصي بنجاح.' : 'Les informations du profil ont été enregistrées avec succès.',
                'check-circle'
            );
        }
        
        // ----------------------------------------------------------------------
        // منطق التمرير (Swipe Logic)
        // ----------------------------------------------------------------------
        
        /**
         * دالة لتحديد البطاقة التالية/السابقة بناءً على التمرير
         * @param {string} direction - 'left' (يمين إلى يسار) أو 'right' (يسار إلى يمين)
         */
        function switchCard(direction) {
            let newCardType = userData.currentCardType;
            const isRTL = htmlElement.getAttribute('dir') === 'rtl';

            if (isRTL) {
                // RTL (العربية): السحب لليسار هو التالي، لليمين هو السابق
                if (userData.currentCardType === 'student' && direction === 'left') {
                    newCardType = 'residence';
                } else if (userData.currentCardType === 'residence' && direction === 'right') {
                    newCardType = 'student';
                }
            } else {
                // LTR (الفرنسية): السحب لليمين هو التالي، لليسار هو السابق (عكس RTL)
                if (userData.currentCardType === 'student' && direction === 'right') {
                    newCardType = 'residence';
                } else if (userData.currentCardType === 'residence' && direction === 'left') {
                    newCardType = 'student';
                }
            }
            
            // إذا تغير نوع البطاقة، قم بعرضها
            if (newCardType !== userData.currentCardType) {
                displayCard(newCardType);
            }
        }
        
        /**
         * تهيئة كشف الإيماءات (Gestures) على عنصر محدد
         * @param {HTMLElement} element - العنصر المراد تفعيل التمرير عليه
         */
        function setupSwipeDetection(element) {
            let startX = 0;
            let endX = 0;
            const threshold = 50; // الحد الأدنى للمسافة (بالبيكسل) لاحتسابها كسحب

            // عند بدء اللمس
            element.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                endX = startX; // إعادة تعيين
            }, { passive: true }); // استخدام passive: true لتحسين الأداء

            // عند نهاية اللمس
            element.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;

                const deltaX = startX - endX; // موجب إذا كان السحب من اليمين إلى اليسار (Swipe Left)

                if (Math.abs(deltaX) > threshold) {
                    if (deltaX > 0) {
                        // السحب من اليمين إلى اليسار (Swipe Left)
                        switchCard('left'); 
                    } else {
                        // السحب من اليسار إلى اليمين (Swipe Right)
                        switchCard('right');
                    }
                }
                // إعادة تعيين
                startX = 0;
                endX = 0;
            }, { passive: true });
        }


        // ----------------------------------------------------------------------
        // الدوال الأساسية (Navigation and Utilities)
        // ----------------------------------------------------------------------
        
        // دالة التنقل بين الشاشات
        function navigate(screen, clickedButton, isInitialLoad = false) {
            
            // 1. تحديث حالة الأزرار في القائمة السفلية
            navItems.forEach(item => {
                // إزالة فئة 'active' من الجميع
                item.classList.remove('active');
            });
            
            // تفعيل الزر الحالي
            if (clickedButton) {
                clickedButton.classList.add('active');
            }


            // 2. مسح المحتوى الحالي وعرض المحتوى حسب الشاشة
            contentArea.innerHTML = '';

            if (screen === 'home') {
                renderHome();
                headerTitle.textContent = t('portal_title');
            } else if (screen === 'cards') {
                renderCards();
                headerTitle.textContent = t('nav_cards');
            } else if (screen === 'profile') {
                renderProfile();
                headerTitle.textContent = t('nav_profile');
            }

            // 3. إعادة إنشاء أيقونات Lucide
            lucide.createIcons();
            
            // 4. تحديث النصوص في شريط التنقل السفلي
            updateNavText();
        }
        
        // دالة مساعدة لتحديث نصوص شريط التنقل
        function updateNavText() {
             document.querySelector('button[onclick*="\'home\'"] span').textContent = t('nav_home');
             document.querySelector('button[onclick*="\'cards\'"] span').textContent = t('nav_cards');
             document.querySelector('button[onclick*="\'profile\'"] span').textContent = t('nav_profile');
        }

        /**
         * دالة لعرض رسالة مخصصة (تحل محل alert)
         */
        function displayCustomMessage(title, message, iconName) {
            // إزالة أي مودال سابق لضمان عرض واحد فقط
            const existingModal = document.getElementById('customModal');
            if (existingModal) existingModal.remove();

            // إنشاء مودال HTML بسيط
            const modalHtml = `
                <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" onclick="document.getElementById('customModal').remove()">
                    <div class="bg-white rounded-xl p-6 max-w-xs w-full shadow-2xl" onclick="event.stopPropagation()" dir="${userData.currentLanguage === 'ar-DZ' ? 'rtl' : 'ltr'}">
                        <div class="flex items-center justify-between mb-4 border-b pb-2">
                            <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                            <i data-lucide="${iconName}" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <p class="text-gray-700 whitespace-pre-line">${message}</p>
                        <button class="w-full mt-6 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition" onclick="document.getElementById('customModal').remove()">
                            ${userData.currentLanguage === 'ar-DZ' ? 'حسناً' : 'D\'accord'}
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            lucide.createIcons();
        }


        // ----------------------------------------------------------------------
        // 1. شاشة الرئيسية (Home Screen) 
        // ----------------------------------------------------------------------
        function renderHome() {
            // ملاحظة: النصوص داخل المربعات لا يتم ترجمتها حالياً للحفاظ على البساطة
            const tiles = [
                { title: 'كشف النقاط', icon: 'file-text' },
                { title: 'جدول التوقيت', icon: 'calendar' },
                { title: 'المجموعة والفوج', icon: 'users' },
                { title: 'جدول الامتحانات', icon: 'calendar-check' },
                { title: 'نقاط الامتحانات', icon: 'graduation-cap' },
                { title: 'التقييم', icon: 'award' },
                { title: 'النسبة المئوية (%)', icon: 'pie-chart' },
                { title: 'الوثائق الأكاديمية', icon: 'folder-open' },
                { title: 'الديون', icon: 'calculator' },
                { title: 'عطلة أكاديمية', icon: 'archive' },
                { title: 'التسجيلات', icon: 'book-open' },
                { title: 'الإطعام', icon: 'utensils' },
                { title: 'خدمات أخرى', icon: 'grid' },
            ];

            const headerHtml = `
                <div class="bg-[--primary-green] rounded-2xl p-4 shadow-lg mb-4 text-center">
                    <img src="https://placehold.co/100x30/008060/ffffff?text=PROGRES" alt="PROGRES Logo" class="mx-auto h-8 mb-2" onerror="this.src='https://placehold.co/100x30/008060/ffffff?text=PROGRES'">
                    <p class="text-white text-sm font-light">${userData.currentLanguage === 'ar-DZ' ? 'الجمهورية الجزائرية الديمقراطية الشعبية' : 'République Algérienne Démocratique et Populaire'}</p>
                    <p class="text-white text-xs">${t('university_name')}</p>
                </div>
            `;

            const tilesHtml = tiles.map(tile => `
                <button class="bg-white hover:bg-gray-50 active:bg-gray-100 rounded-2xl p-4 flex flex-col items-center justify-center text-center shadow-md transition duration-150 ease-in-out h-32">
                    <i data-lucide="${tile.icon}" class="w-8 h-8 text-[--primary-green] mb-2"></i>
                    <span class="text-sm font-medium text-gray-700">${tile.title}</span>
                </button>
            `).join('');

            contentArea.innerHTML = `
                ${headerHtml}
                <div class="grid grid-cols-2 gap-4 pb-4">
                    ${tilesHtml}
                </div>
            `;

            // إزالة فئات توسيط البطاقة لصفحة الرئيسية
            contentArea.classList.remove('flex', 'flex-col', 'items-center', 'justify-start');
            contentArea.classList.add('p-4', 'space-y-4');
        }

        // ----------------------------------------------------------------------
        // 2. شاشة البطاقات (Cards Screen)
        // ----------------------------------------------------------------------
        function renderCards() {
            const isRTL = userData.currentLanguage === 'ar-DZ';
            
            // إضافة فئات التوسيط للبطاقة وجعلها تبدأ من الأعلى
            contentArea.classList.add('flex', 'flex-col', 'items-center', 'justify-start');
            contentArea.classList.remove('p-4', 'space-y-4'); 

            const controlsHtml = `
                <div class="w-full max-w-sm p-4 space-y-4">
                    <!-- أزرار اختيار نوع البطاقة -->
                    <div class="flex bg-white rounded-xl shadow-md p-1">
                        <button id="btnStudentCard" class="flex-1 py-2 rounded-lg font-bold text-sm transition-colors duration-200" onclick="displayCard('student')">
                            ${t('student_card_button')}
                        </button>
                        <button id="btnResidenceCard" class="flex-1 py-2 rounded-lg font-bold text-sm transition-colors duration-200" onclick="displayCard('residence')">
                            ${t('residence_card_button')}
                        </button>
                    </div>

                    <!-- حاوية عرض البطاقة - تم إضافة فئات الانتقال إليها -->
                    <div id="cardDisplayArea" class="w-full flex justify-center py-4 transition-opacity duration-300 opacity-0">
                        <!-- سيتم تحميل البطاقة هنا بواسطة displayCard() -->
                    </div>

                    <!-- حاوية أدوات التخصيص (مرئية دائماً) -->
                    <div id="customizationControls" class="space-y-4">
                        <!-- خاصية رفع الصورة الشخصية (مستقلة) -->
                        <div class="bg-white p-4 rounded-xl shadow-md space-y-3">
                            <p class="text-sm font-bold text-gray-700">${t('change_profile_image')}</p>
                            <input type="file" id="imageUploader" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer">
                            <p class="text-xs text-gray-500 mt-2">${t('note_image_shared')}</p>
                        </div>

                        <!-- 1. خلفية بطاقة الطالب -->
                        <div class="bg-white p-4 rounded-xl shadow-md space-y-3">
                            <p class="text-sm font-bold text-gray-700">${t('change_student_bg')}</p>
                            <input type="file" id="studentBackgroundUploader" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 cursor-pointer">
                            <p class="text-xs text-gray-500 mt-2">${t('note_student_bg')}</p>
                            <button class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-sm hover:bg-gray-300 transition duration-150 mt-2" onclick="removeCardBackground('student')">
                                ${t('remove_background')}
                            </button>
                        </div>

                        <!-- 2. خلفية بطاقة الإقامة -->
                        <div class="bg-white p-4 rounded-xl shadow-md space-y-3">
                            <p class="text-sm font-bold text-gray-700">${t('change_residence_bg')}</p>
                            <input type="file" id="residenceBackgroundUploader" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 cursor-pointer">
                            <p class="text-xs text-gray-500 mt-2">${t('note_residence_bg')}</p>
                            <button class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-sm hover:bg-gray-300 transition duration-150 mt-2" onclick="removeCardBackground('residence')">
                                ${t('remove_background')}
                            </button>
                        </div>
                    </div> <!-- نهاية customizationControls -->
                </div>
            `;

            contentArea.innerHTML = controlsHtml;

            // عرض البطاقة الافتراضية بعد تحميل المحتوى
            displayCard(userData.currentCardType, true);
            
            // **تفعيل كشف التمرير على منطقة عرض البطاقة**
            const cardDisplayArea = document.getElementById('cardDisplayArea');
            if (cardDisplayArea) {
                setupSwipeDetection(cardDisplayArea);
            }

            // منطق تحميل الصورة الشخصية (مشتركة)
            document.getElementById('imageUploader').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userData.idCardImage = e.target.result;
                        // تحديث الصورة في الهيدر والبطاقة
                        document.getElementById('profileImageHeader').src = userData.idCardImage;
                        displayCard(userData.currentCardType);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // منطق تحميل خلفية بطاقة الطالب
            document.getElementById('studentBackgroundUploader').addEventListener('change', function(event) {
                handleBackgroundUpload(event, 'student');
            });

            // منطق تحميل خلفية بطاقة الإقامة
            document.getElementById('residenceBackgroundUploader').addEventListener('change', function(event) {
                handleBackgroundUpload(event, 'residence');
            });
            
            // يجب إعادة إنشاء الأيقونات للتأكد من ظهورها
            lucide.createIcons();
        }

        /**
         * دالة مساعدة لمعالجة رفع الخلفية وتخزينها في المتغير الصحيح
         * @param {Event} event - حدث الرفع
         * @param {string} type - 'student' أو 'residence'
         */
        function handleBackgroundUpload(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (type === 'student') {
                        userData.studentCardBackground = e.target.result;
                    } else if (type === 'residence') {
                        userData.residenceCardBackground = e.target.result;
                    }
                    // إعادة عرض البطاقة لتطبيق الخلفية الجديدة على البطاقة الحالية
                    displayCard(userData.currentCardType);
                };
                reader.readAsDataURL(file);
            }
        }

        /**
         * دالة لإزالة الخلفية المضافة لبطاقة معينة
         * @param {string} type - 'student' أو 'residence'
         */
        function removeCardBackground(type) {
            if (type === 'student') {
                userData.studentCardBackground = null;
            } else if (type === 'residence') {
                userData.residenceCardBackground = null;
            }
            // تحديث العرض إذا كانت البطاقة التي تم إزالة خلفيتها هي البطاقة المعروضة حاليًا
            if (userData.currentCardType === type) {
                displayCard(userData.currentCardType);
            }
        }

        /**
         * دالة لعرض تصميم بطاقة معين (بطاقة الطالب أو الإقامة) مع تأثير الحركة
         * @param {string} type - 'student' أو 'residence'
         * @param {boolean} skipAnimation - لتخطي الحركة عند تحميل الشاشة لأول مرة
         */
        function displayCard(type, skipAnimation = false) {
            const cardDisplayArea = document.getElementById('cardDisplayArea');
            if (!cardDisplayArea) return;

            // 1. تحديث حالة الأزرار
            const btnStudent = document.getElementById('btnStudentCard');
            const btnResidence = document.getElementById('btnResidenceCard');
            if (btnStudent && btnResidence) {
                if (type === 'student') {
                    btnStudent.classList.add('bg-[--primary-green]', 'text-white');
                    btnResidence.classList.remove('bg-[--primary-green]', 'text-white');
                    btnResidence.classList.add('text-gray-700');
                } else {
                    btnResidence.classList.add('bg-[--primary-green]', 'text-white');
                    btnStudent.classList.remove('bg-[--primary-green]', 'text-white');
                    btnStudent.classList.add('text-gray-700');
                }
            }

            // 2. تطبيق تأثير التلاشي للإخفاء
            if (!skipAnimation) {
                cardDisplayArea.classList.remove('opacity-100');
                cardDisplayArea.classList.add('opacity-0');
            } else {
                // إذا كان أول تحميل، لا تنتظر
                updateCardContent(type, cardDisplayArea);
                cardDisplayArea.classList.add('opacity-100');
                return;
            }

            // 3. الانتظار حتى اكتمال التلاشي (300ms) ثم تحديث المحتوى
            setTimeout(() => {
                updateCardContent(type, cardDisplayArea);
                
                // 4. تطبيق تأثير الظهور
                cardDisplayArea.classList.remove('opacity-0');
                cardDisplayArea.classList.add('opacity-100');
            }, 300);

            userData.currentCardType = type;
        }

        /**
         * دالة مساعدة لتوليد محتوى البطاقة بناءً على النوع (الآن فارغة تمامًا)
         */
        function updateCardContent(type, cardDisplayArea) {
            let cardHtml = '';
            
            // تحديد الخلفية الصحيحة بناءً على نوع البطاقة المعروضة
            const cardBackground = (type === 'student') 
                ? userData.studentCardBackground 
                : userData.residenceCardBackground;

            // تطبيق الخلفية المخصصة أو تركها فارغة
            const backgroundStyle = cardBackground 
                ? `style="background-image: url('${cardBackground}'); background-size: cover; background-position: center;"` 
                : '';

            // تصميم البطاقة الفارغة مع الخلفية والنقوش
            cardHtml = `
                <!-- البطاقة الفارغة (Hollow Card) -->
                <div id="idCard" class="id-card-container bg-white rounded-2xl p-3 shadow-2xl relative overflow-hidden" ${backgroundStyle}>
                    
                    <!-- طبقة التعتيم (Overlay) - تستخدم فقط إذا لم يكن هناك صورة خلفية مخصصة -->
                    ${cardBackground ? '' : '<div class="card-overlay"></div>'}
                    
                    <!-- تذييل مزخرف (الخلفية منقطة) - يظهر فقط في حال عدم وجود صورة خلفية مخصصة -->
                    ${cardBackground ? '' : '<div class="absolute inset-0 bg-repeat opacity-5" style="background-image: radial-gradient(#efefef 1px, transparent 1px); background-size: 8px 8px;"></div>'}
                    
                    <!-- المحتوى الداخلي الفارغ -->
                    <div class="relative z-20 w-full h-full p-4 text-center">
                         <!-- المحتوى فارغ هنا لانتظار التصميم الفعلي -->
                    </div>
                </div>
            `;

            cardDisplayArea.innerHTML = cardHtml;
            lucide.createIcons();
        }

        // ----------------------------------------------------------------------
        // 3. شاشة الملف الشخصي (Profile Screen) 
        // ----------------------------------------------------------------------
        function renderProfile() {
            const isRTL = userData.currentLanguage === 'ar-DZ';
            
            // تحديث الصورة في الهيدر
            const profileImageHeader = document.getElementById('profileImageHeader');
            if (profileImageHeader) profileImageHeader.src = userData.idCardImage;
            
            // تحديد اتجاه النص والحاويات
            const directionClass = isRTL ? 'text-right' : 'text-left';
            const itemMarginClass = isRTL ? 'ml-4' : 'mr-4'; // عكس الهامش الجانبي
            
            // التعديلات هنا: إضافة زر تعديل المعلومات
            const profileHtml = `
                <!-- بطاقة الاسم والجامعة (الخضراء) -->
                <div class="bg-[--primary-green] rounded-2xl p-4 flex items-center shadow-lg mb-4 text-white ${isRTL ? '' : 'flex-row-reverse'}">
                    <img id="profileImageCard" src="${userData.idCardImage}" alt="صورة المستخدم" class="w-14 h-14 rounded-full object-cover border-2 border-white ${itemMarginClass}">
                    <div class="${directionClass} flex-grow">
                        <!-- الاسم بالإنجليزية ثابت -->
                        <p class="text-lg font-bold">${userData.englishName}</p>
                        <!-- الجامعة يتم ترجمتها -->
                        <p class="text-sm font-light">${t('university_name_profile')}</p>
                    </div>
                </div>

                <!-- زر تعديل المعلومات -->
                <button onclick="openEditProfileModal()" class="w-full bg-blue-500 text-white p-3 rounded-2xl font-bold text-base shadow-lg hover:bg-blue-600 transition duration-150 mb-4">
                    <i data-lucide="edit" class="w-5 h-5 inline-block ${isRTL ? 'ml-2' : 'mr-2'}"></i>
                    ${t('edit_info_button')}
                </button>

                <!-- بطاقة مكان الميلاد -->
                <div class="bg-white rounded-2xl p-4 flex items-start space-x-3 ${isRTL ? 'space-x-reverse' : ''} shadow-md">
                    <i data-lucide="map-pin" class="w-6 h-6 text-[--primary-green] flex-shrink-0 mt-0.5"></i>
                    <div class="${directionClass} flex-grow">
                        <p class="text-sm font-medium text-gray-500">${t('birth_place_label')}</p>
                        <p class="text-lg font-bold text-gray-800 mt-1">${userData.birthPlace}</p>
                    </div>
                </div>

                <!-- بطاقة تاريخ الميلاد -->
                <div class="bg-white rounded-2xl p-4 flex items-start space-x-3 ${isRTL ? 'space-x-reverse' : ''} shadow-md mt-4">
                    <i data-lucide="calendar" class="w-6 h-6 text-[--primary-green] flex-shrink-0 mt-0.5"></i>
                    <div class="${directionClass} flex-grow">
                        <p class="text-sm font-medium text-gray-500">${t('birth_date_label')}</p>
                        <p class="text-lg font-bold text-gray-800 mt-1">${userData.birthDate}</p>
                    </div>
                </div>

                <!-- بطاقة تغيير اللغة -->
                <div class="bg-white rounded-2xl p-4 flex justify-between items-center shadow-md mt-4">
                    <div class="flex items-center space-x-3 ${isRTL ? 'space-x-reverse' : ''}">
                        <i data-lucide="languages" class="w-6 h-6 text-[--primary-green] flex-shrink-0"></i>
                        <p class="text-base font-medium text-gray-800">${t('language_switch_label')}</p>
                    </div>
                    <!-- الزر يستدعي دالة التبديل ويظهر اللغة الحالية -->
                    <button id="languageButton" onclick="toggleLanguage()" class="bg-[--primary-green] text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg hover:bg-green-700 transition duration-150">
                        ${userData.currentLanguage}
                    </button>
                </div>
                
                <!-- زر تسجيل الخروج -->
                <button class="w-full bg-[--logout-red] text-white p-4 rounded-2xl font-bold text-lg shadow-lg hover:bg-red-700 transition duration-150 mt-6">
                    ${t('logout_button')}
                </button>
            `;
            contentArea.innerHTML = profileHtml;
            // إزالة فئات توسيط البطاقة لصفحة الملف الشخصي
            contentArea.classList.remove('flex', 'flex-col', 'items-center', 'justify-center');
            contentArea.classList.add('p-4', 'space-y-4');
        }

    </script>
</body>
</html>
