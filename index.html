<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Mobile UI</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font: Almarai for better Arabic rendering -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&display=swap');
        :root {
            --color-primary-green: #00A37A;
            --color-dark-slate: #383E58;
            --color-logout-red: #E85A5A;
            --color-light-bg: #F0F0F0;
        }

        body {
            background-color: var(--color-light-bg);
            font-family: 'Almarai', 'Inter', sans-serif;
        }

        /* Utility class for the primary green color, matching the screenshots */
        .bg-primary-green { background-color: var(--color-primary-green); }
        .text-primary-green { color: var(--color-primary-green); }
        .bg-dark-slate { background-color: var(--color-dark-slate); }
        .bg-logout-red { background-color: var(--color-logout-red); }

        /* Ensure the app container simulates a mobile screen */
        #app-container {
            max-width: 420px;
            min-height: 100vh;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            background-color: white;
        }

        /* --- Card Specific Styles (Matching the provided images) --- */
        
        .id-card-container {
            perspective: 1000px;
            /* Fixed aspect ratio to resemble the physical card - Adjusted slightly for content fitting */
            height: 400px; 
            margin-top: 1rem;
        }

        .id-card {
            background: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 1.5rem;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
            overflow: hidden; /* Important for clean edges */
        }
        
        /* Card Flip State */
        .id-card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1.5rem;
            padding: 1.5rem;
            overflow: hidden;
            direction: rtl; /* Ensure all text flows right-to-left unless overridden */
        }

        .card-front {
            z-index: 2;
            transform: rotateY(0deg);
            background-color: white; 
        }

        .card-back {
            background-color: #f7f7f7;
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
        }

        /* Right Wavy Border (Exactly like the images) - Only for default design */
        .default-design::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 100%;
            background-image: repeating-linear-gradient(
                to top,
                var(--color-primary-green) 0px,
                var(--color-primary-green) 1px,
                transparent 1px,
                transparent 10px
            );
            background-size: 100% 10px;
            opacity: 0.5;
        }

        /* Light Spotted/Dotted background - Only for default design */
        .default-design::before {
            content: '';
            position: absolute;
            top: 100px;
            right: 20px;
            width: 150px;
            height: 200px;
            background-image: radial-gradient(circle, #00A37A 1px, rgba(0, 163, 122, 0) 1px);
            background-size: 8px 8px;
            opacity: 0.1;
            transform: rotate(-90deg);
        }

        /* Specific text styling for the card details */
        .card-text {
            position: absolute;
            font-size: 0.7rem; /* Adjusted for density */
            font-weight: 500;
            white-space: nowrap;
        }

        .card-label {
            position: absolute;
            font-size: 0.6rem;
            font-weight: 400;
            color: #555;
            white-space: nowrap;
        }
        
        /* Full Card Image Styles */
        .full-card-image {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1.5rem;
            z-index: 1; /* Below the long-press overlay */
        }
        .full-card-overlay {
            position: absolute;
            inset: 0;
            z-index: 10;
        }
        
        /* Ensure inputs blend into the profile card */
        .profile-input-field {
            background-color: transparent;
            color: white;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            padding: 0 0 2px 0;
            transition: border-bottom-color 0.2s;
        }
        .profile-input-field:focus {
            outline: none;
            border-bottom: 1px solid white;
        }

        /* Style for the hidden input file field */
        .profile-image-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

    </style>
</head>
<body class="bg-light-bg">

    <div id="app-container" class="flex flex-col">

        <!-- Main Content Area -->
        <main id="main-content" class="flex-grow p-4 pb-24 overflow-y-auto">
            <!-- Views will be rendered here by JavaScript -->
        </main>

        <!-- Bottom Navigation (Footer) -->
        <nav id="bottom-nav" class="bg-dark-slate fixed bottom-0 left-0 right-0 z-50 h-20 shadow-2xl" style="max-width: 420px; margin: 0 auto;">
            <div class="flex h-full">
                <!-- Home Button -->
                <button data-view="home" class="nav-item flex-1 flex flex-col items-center justify-center text-white/70 transition-colors" onclick="showView('home')">
                    <i data-lucide="home" class="w-6 h-6"></i>
                    <span class="text-xs mt-1">الرئيسية</span>
                </button>
                <!-- Cards Button -->
                <button data-view="cards" class="nav-item flex-1 flex flex-col items-center justify-center text-white/70 transition-colors" onclick="showView('cards')">
                    <i data-lucide="credit-card" class="w-6 h-6"></i>
                    <span class="text-xs mt-1">البطاقات</span>
                </button>
                <!-- Profile Button -->
                <button data-view="profile" class="nav-item flex-1 flex flex-col items-center justify-center text-white/70 transition-colors" onclick="showView('profile')">
                    <i data-lucide="user" class="w-6 h-6"></i>
                    <span class="text-xs mt-1">الملف الشخصي</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        // --- Data Definitions ---
        const USER_DATA = {
            name_en: "BERKANI AMAYAS",
            name_ar: "بركاني أمياس",
            surname_ar: "بركاني",
            firstname_ar: "أمياس",
            university_en: "université de béjaia", 
            university_ar: "جامعة بجاية", 
            dob: "2005-12-04", 
            pob_ar: "بجاية", 
            major_ar: "علوم الطبيعة والحياة",
            academic_year: "2025/2026",
            id_student: "UN0601202525353025418", 
            id_residence: "4-203",
            card_residence_details: "يستفيد هذا الطالب من خدمات النقل",
            residence_building: "بريشاش 3",
            residence_room: "القمر",
            language: "ar-DZ", 
            directorate: "مديرية الخدمات الجامعية بجاية القصر", 
            directorate_residence: "بريشاش 3 - القمر", 
        };

        const HOME_SERVICES = [
            { en: "Discharge", ar: "إبراء الذمة", icon: "file-text" },
            { en: "Timetable", ar: "جدول الأعمال", icon: "calendar" },
            { en: "Group and Section", ar: "المجموعة والقسم", icon: "users" },
            { en: "Exams Schedule", ar: "جدول الامتحانات", icon: "calendar-check" },
            { en: "Exam Grades", ar: "نتائج الامتحانات", icon: "graduation-cap" },
            { en: "Assessment", ar: "التقييم", icon: "pencil" },
            { en: "Percentage (%)", ar: "النسبة المئوية", icon: "pie-chart" },
            { en: "Academic Transcripts", ar: "كشوف النقاط", icon: "folder-open" },
            { en: "Debts", ar: "الديون", icon: "calculator" },
            { en: "Academic vacation", ar: "عطلة أكاديمية", icon: "sun" },
            { en: "Enrollments", ar: "التسجيلات", icon: "credit-card" },
            { en: "Restoration", ar: "الاستعادة", icon: "utensils" },
            { en: "Other services", ar: "خدمات أخرى", icon: "grid" },
        ];

        // --- State Management ---
        let currentView = 'cards'; 
        let currentCard = 'student'; // 'student' or 'residence'
        let isCardFlipped = false;
        
        // State for custom images
        let profileImageUrl = "https://placehold.co/96x96/444444/ffffff?text=صورة"; 
        let cardBackImageUrl = "https://placehold.co/380x380/00A37A/ffffff?text=صورة+خلفية"; 
        let studentCardFrontImageUrl = null; // Custom full front design for student card
        let residenceCardFrontImageUrl = null; // Custom full front design for residence card
        
        // Timer for long press logic 
        let longPressTimer = null;
        const LONG_PRESS_DURATION = 500; // 0.5 seconds

        // --- Utility Functions ---

        /**
         * Renders the header for each view.
         */
        function renderHeader(title, showProfile = false) {
            const profileIcon = showProfile 
                ? `<div class="w-8 h-8 rounded-full overflow-hidden border-2 border-white/50">
                    <img id="header-profile-img" src="${profileImageUrl}" alt="Profile" class="w-full h-full object-cover"/>
                  </div>`
                : '';
            
            return `
                <header class="flex justify-between items-center h-16 pt-4 px-4">
                    <h1 class="text-xl font-bold">${title}</h1>
                    ${profileIcon}
                </header>
            `;
        }

        /**
         * Updates the active state of the bottom navigation bar.
         */
        function updateNav(view) {
            document.querySelectorAll('.nav-item').forEach(item => {
                const icon = item.querySelector('i');
                if (item.dataset.view === view) {
                    item.classList.add('bg-primary-green', 'text-white');
                    item.classList.remove('text-white/70');
                } else {
                    item.classList.remove('bg-primary-green', 'text-white');
                    item.classList.add('text-white/70');
                }
            });
            lucide.createIcons();
        }
        
        /**
         * Renders a standardized detail card for fields in the Profile View.
         */
        const detailCard = (icon, title, value, editable = false, type = 'text', id = '') => `
            <div class="bg-white rounded-xl p-4 mb-4 flex items-center shadow-md" style="direction: rtl;">
                <div class="p-2 rounded-full bg-gray-100 text-primary-green flex-shrink-0">
                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                </div>
                <div class="mr-4 flex-grow text-right">
                    <p class="text-sm text-gray-500">${title}</p>
                    ${editable 
                        ? `<input type="${type}" id="${id}" value="${value}" 
                           class="bg-gray-100 text-black/80 text-base font-semibold w-full p-1 rounded-md text-right border border-transparent focus:border-primary-green transition-colors ${type === 'date' ? 'h-9' : ''}" 
                           placeholder="${type === 'date' ? 'YYYY-MM-DD' : ''}">`
                        : `<p class="text-base font-semibold text-black/80">${value}</p>`
                    }
                </div>
            </div>
        `;


        // --- View Renderers ---

        function renderHomeView() {
            // ... (Home view rendering logic remains the same) ...
            const header = renderHeader("بوابة الطالب", true);
            
            // Simplified PROGRES logo block based on user image IMG_2863.jpg
            const logoBlock = `
                <div class="bg-primary-green rounded-xl p-4 mb-6 shadow-md mt-2">
                    <div class="flex justify-center items-center h-20">
                        <div class="text-center">
                            <h2 class="text-white text-2xl font-bold">PROGRES</h2>
                            <p class="text-white text-xs mt-1">وزارة التعليم العالي والبحث العلمي</p>
                            <p class="text-white text-xs">Ministère de l'Enseignement Supérieur et de la Recherche Scientifique</p>
                        </div>
                    </div>
                </div>
            `;

            const serviceGrid = HOME_SERVICES.map(service => `
                <button class="bg-primary-green rounded-xl p-3 h-20 flex flex-col items-center justify-center text-white shadow-lg text-right" onclick="console.log('${service.en} clicked')">
                    <i data-lucide="${service.icon}" class="w-6 h-6 mb-1"></i>
                    <span class="text-sm font-semibold">${service.ar}</span>
                </button>
            `).join('');

            const content = `
                <div class="grid grid-cols-2 gap-3">
                    ${serviceGrid}
                </div>
            `;

            return header + logoBlock + content;
        }
        
        /**
         * Renders the card front, either with custom image or default design.
         */
        function renderCardFront(type) {
            const isStudent = type === 'student';
            const customImageUrl = isStudent ? studentCardFrontImageUrl : residenceCardFrontImageUrl;

            // Hidden input for full card image replacement (used by long press)
            const hiddenFileInput = `
                <input type="file" id="full-card-front-input" accept="image/*" class="profile-image-input" 
                    onchange="handleImageChange(event, 'full_card_front')">
            `;
            
            if (customImageUrl) {
                // --- CUSTOM CARD DESIGN ---
                // If a custom image is set, use it as the background image
                return `
                    <div class="card-face card-front relative p-0 overflow-hidden">
                        <img src="${customImageUrl}" alt="Custom Card Front" class="full-card-image" />
                        <!-- Add a transparent overlay to handle long press -->
                        <div class="full-card-overlay"></div>
                        ${hiddenFileInput}
                    </div>
                `;
            }

            // --- DEFAULT DETAILED DESIGN (If no custom image) ---
            
            const governmentBlock = isStudent
                ? `
                    <div class="absolute top-10 left-5 flex flex-col items-start text-[9px] font-semibold leading-tight text-right w-1/3">
                        <p class="mb-1 text-[10px]">الجمهورية الجزائرية الديمقراطية الشعبية</p>
                        <p>وزارة التعليم العالي والبحث العلمي</p>
                        <p>مديرية الخدمات الجامعية</p>
                        <p class="font-bold text-black/90">${USER_DATA.university_ar}</p>
                    </div>
                    <!-- Placeholder for Algerian Government Logo - Top Right -->
                    <div class="absolute top-8 right-6 w-8 h-8 rounded-full bg-red-600 border-2 border-green-600"></div>
                `
                : `
                    <div class="absolute top-10 left-5 flex flex-col items-start text-[9px] font-semibold leading-tight text-right w-1/3">
                        <p class="mb-1 text-[10px]">الجمهورية الجزائرية الديمقراطية الشعبية</p>
                        <p>وزارة التعليم العالي والبحث العلمي</p>
                        <p class="font-bold text-black/90">${USER_DATA.directorate}</p>
                    </div>
                    <!-- Placeholder for Directorate Logo - Top Right -->
                    <div class="absolute top-8 right-6 w-8 h-8 rounded-full bg-red-600 border-2 border-green-600"></div>
                `;

            const cardTitle = isStudent 
                ? `<div class="absolute top-1/2 left-1/4 transform -translate-x-1/2 -translate-y-1/2 -rotate-90 origin-center text-4xl font-extrabold text-black/90 tracking-wider whitespace-nowrap">بطاقة الطالب</div>`
                : `<div class="absolute top-1/2 left-1/4 transform -translate-x-1/2 -translate-y-1/2 -rotate-90 origin-center text-4xl font-extrabold text-black/90 tracking-wider whitespace-nowrap">بطاقة الإقامة</div>`;

            const longID = isStudent
                ? `<div class="absolute top-[250px] right-[2px] transform -translate-y-1/2 -rotate-90 origin-top-right text-[10px] font-bold tracking-widest text-primary-green whitespace-nowrap">${USER_DATA.id_student}</div>`
                : ``;

            const academicYear = `
                <div class="absolute top-10 right-10 text-xs font-bold text-primary-green transform -rotate-90 origin-top-right whitespace-nowrap">
                    السنة الجامعية ${USER_DATA.academic_year}
                </div>
            `;
            
            const qrCode = `
                <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 w-20 h-20 p-1 bg-white border border-gray-300">
                    <img src="https://placehold.co/80x80/1a1a1a/ffffff?text=QR" alt="QR Code" class="w-full h-full object-cover"/>
                </div>
            `;
            
            // Profile Image (Now clickable for short press only)
            const profileImage = `
                <div id="card-image-wrapper" class="absolute top-10 left-1/2 transform -translate-x-1/2 w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-md bg-gray-200 cursor-pointer"
                    onclick="document.getElementById('small-profile-image-input').click(); event.stopPropagation();">
                    
                    <img id="card-profile-img" src="${profileImageUrl}" alt="Student Photo" class="w-full h-full object-cover"/>
                    <!-- Hidden Input field to change small profile image -->
                    <input type="file" id="small-profile-image-input" accept="image/*" class="profile-image-input" 
                        onchange="handleImageChange(event, 'profile')" onclick="event.stopPropagation();">
                </div>
            `;

            const fields = isStudent 
                ? `
                    <!-- Row 1: Name and Surname (Vertical) -->
                    <p class="card-text top-[150px] left-[130px] font-bold text-base">${USER_DATA.firstname_ar}</p>
                    <p class="card-text top-[150px] left-[180px] font-bold text-base">${USER_DATA.surname_ar}</p>
                    
                    <!-- Row 2: Major & POB/DOB (Horizontal) -->
                    <p class="card-text top-[200px] right-[20px] font-bold text-sm">${USER_DATA.major_ar}</p>
                    <p class="card-text top-[200px] left-[150px] font-bold text-sm">${USER_DATA.dob}</p>
                    <p class="card-text top-[200px] left-[200px] font-bold text-sm">${USER_DATA.pob_ar}</p>

                    <!-- Labels for Horizontal Fields -->
                    <p class="card-label top-[225px] right-[20px] text-primary-green">التخصص</p>
                    <p class="card-label top-[225px] left-[140px] text-primary-green">تاريخ ومكان الميلاد</p>
                    <p class="card-label top-[225px] left-[200px] text-primary-green">الميلاد</p>
                ` 
                : `
                    <!-- Row 1: Name and Surname (Vertical) -->
                    <p class="card-text top-[150px] left-[130px] font-bold text-base">${USER_DATA.firstname_ar}</p>
                    <p class="card-text top-[150px] left-[180px] font-bold text-base">${USER_DATA.surname_ar}</p>

                    <!-- Row 2: Residence Details (Horizontal) -->
                    <p class="card-text top-[200px] right-[20px] font-bold text-sm">${USER_DATA.directorate_residence} - ${USER_DATA.id_residence}</p>
                    <p class="card-text top-[200px] left-[150px] font-bold text-sm">${USER_DATA.pob_ar}</p>
                    <p class="card-text top-[200px] left-[200px] font-bold text-sm">${USER_DATA.dob}</p>

                    <!-- Labels for Horizontal Fields -->
                    <p class="card-label top-[225px] right-[20px] text-primary-green">الإقامة</p>
                    <p class="card-label top-[225px] left-[140px] text-primary-green">تاريخ ومكان الميلاد</p>
                    <p class="card-label top-[225px] left-[200px] text-primary-green">الميلاد</p>
                    
                    <!-- Residence Card Extra Info (Vertical Text) -->
                    <div class="absolute top-[100px] left-[20px] text-[10px] text-center font-bold text-primary-green w-10">
                        ${USER_DATA.card_residence_details.split(' ').join('<br>')}
                    </div>
                `;

            return `
                <div class="card-face card-front relative default-design">
                    ${governmentBlock}
                    ${cardTitle}
                    ${longID}
                    ${academicYear}
                    ${profileImage}
                    ${fields}
                    ${qrCode}
                    ${hiddenFileInput}
                </div>
            `;
        }

        function renderCardBack(type) {
            // ... (Card back rendering logic remains the same) ...
            const isStudent = type === 'student';
            const backTitle = isStudent ? "الوجه الخلفي لبطاقة الطالب" : "الوجه الخلفي لبطاقة الإقامة";

            return `
                <div class="card-face card-back relative">
                    <h3 class="text-xl font-bold text-dark-slate mb-4">${backTitle}</h3>
                    <p class="text-sm text-gray-600 mb-6">انقر لقلب البطاقة مرة أخرى</p>

                    <!-- Back Image Display -->
                    <div class="w-4/5 max-w-xs h-40 rounded-xl overflow-hidden shadow-xl border-4 border-gray-300 mb-6">
                        <img id="card-back-img-display" src="${cardBackImageUrl}" alt="Card Back" class="w-full h-full object-cover"/>
                    </div>

                    <!-- Input field to change back image -->
                    <label for="backImageInput" class="bg-primary-green text-white px-4 py-2 rounded-lg font-semibold text-sm shadow-md cursor-pointer flex items-center">
                        <i data-lucide="image" class="w-5 h-5 ml-2"></i>
                        تغيير صورة الخلف
                    </label>
                    <input type="file" id="backImageInput" accept="image/*" class="hidden" onchange="handleImageChange(event, 'back')">
                </div>
            `;
        }


        function renderCardsView() {
            const cardToggle = `
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="toggle-student" class="p-2 w-full max-w-[150px] rounded-full text-sm font-semibold transition-all shadow-md" onclick="switchCard('student')">
                        بطاقة الطالب
                    </button>
                    <button id="toggle-residence" class="p-2 w-full max-w-[150px] rounded-full text-sm font-semibold transition-all shadow-md" onclick="switchCard('residence')">
                        بطاقة الإقامة
                    </button>
                </div>
            `;
            
            // Event handlers for long press/short click are now in JS functions
            const cardContainer = `
                <div id="id-card-container" class="id-card-container" 
                    ontouchstart="cardInteractionStart(event)" 
                    ontouchend="cardInteractionEnd(event)"
                    onmousedown="cardInteractionStart(event)" 
                    onmouseup="cardInteractionEnd(event)"
                    onmouseout="cardInteractionEnd(event)">
                    
                    <div id="id-card" class="id-card ${isCardFlipped ? 'flipped' : ''}">
                        ${renderCardFront(currentCard)}
                        ${renderCardBack(currentCard)}
                    </div>
                </div>
                <p class="text-center text-gray-500 text-sm mt-3">انقر لقلب البطاقة. اضغط مطولاً على الوجه الأمامي لتغييره.</p>
            `;

            const header = renderHeader("بطاقات الهوية");
            
            return header + cardToggle + cardContainer;
        }

        function renderProfileView() {
            // ... (Profile view rendering logic remains the same) ...
            const header = renderHeader("ملفي الشخصي");

            const editableProfileCard = `
                <div class="bg-primary-green rounded-xl p-4 mb-4 flex items-center shadow-lg mt-2" style="direction: rtl;">
                    <!-- Profile Image container -->
                    <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white/50 flex-shrink-0">
                        <img id="profile-card-img" src="${profileImageUrl}" alt="Profile" class="w-full h-full object-cover"/>
                    </div>
                    
                    <div class="mr-4 text-right text-white flex-grow">
                        <p class="text-xs font-light">الاسم بالإنجليزية (اللقب الاسم)</p>
                        <input type="text" id="edit-name-en" value="${USER_DATA.name_en}" placeholder="BERKANI AMAYAS" 
                            class="profile-input-field text-white text-lg font-bold w-full text-right mb-2" 
                            style="direction: ltr;">
                        
                        <p class="text-xs font-light mt-2">اللقب بالعربية</p>
                        <input type="text" id="edit-surname-ar" value="${USER_DATA.surname_ar}" placeholder="بركاني"
                            class="profile-input-field text-white text-base w-full text-right mb-2">
                        
                        <p class="text-xs font-light mt-2">الاسم بالعربية</p>
                        <input type="text" id="edit-firstname-ar" value="${USER_DATA.firstname_ar}" placeholder="أمياس"
                            class="profile-input-field text-white text-base w-full text-right">

                        <p class="text-xs font-light mt-2">الجامعة بالإنجليزية</p>
                        <input type="text" id="edit-university-en" value="${USER_DATA.university_en}" placeholder="université de béjaia"
                            class="profile-input-field text-white text-base w-full text-right"
                            style="direction: ltr;">
                    </div>
                </div>
            `;

            const saveButton = `
                <button id="save-button" class="bg-primary-green text-white w-full py-3 rounded-xl font-bold text-lg shadow-md transition-all hover:bg-opacity-90 mb-4" onclick="saveProfileChanges()">
                    حفظ التغييرات
                </button>
            `;

            const editablePOBCard = detailCard('map-pin', 'مكان الميلاد', USER_DATA.pob_ar, true, 'text', 'edit-pob-ar');
            const editableDOBCard = detailCard('cake', 'تاريخ الميلاد', USER_DATA.dob, true, 'date', 'edit-dob');
            
            const languageCard = `
                <div class="bg-white rounded-xl p-4 mb-6 flex justify-between items-center shadow-md" style="direction: rtl;">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-gray-100 text-primary-green">
                            <i data-lucide="languages" class="w-5 h-5"></i>
                        </div>
                        <span class="mr-4 text-base font-semibold text-black/80">لغة التطبيق</span>
                    </div>
                    <select id="edit-language"
                            class="bg-gray-100 text-black/80 font-semibold px-4 py-2 rounded-lg text-sm appearance-none cursor-pointer border border-transparent focus:border-primary-green transition-colors">
                        <option value="ar-DZ" ${USER_DATA.language === 'ar-DZ' ? 'selected' : ''}>العربية (الجزائر)</option>
                        <option value="fr-DZ" ${USER_DATA.language === 'fr-DZ' ? 'selected' : ''}>الفرنسية (الجزائر)</option>
                        <option value="en-US" ${USER_DATA.language === 'en-US' ? 'selected' : ''}>الإنجليزية</option>
                    </select>
                </div>
            `;

            const logoutButton = `
                <button class="bg-logout-red text-white w-full py-3 rounded-xl font-bold text-lg shadow-md transition-all hover:bg-opacity-90" onclick="console.log('Logout clicked')">
                    تسجيل الخروج
                </button>
            `;

            const content = `
                ${editableProfileCard}
                ${saveButton}
                ${editablePOBCard}
                ${editableDOBCard}
                ${languageCard}
                ${logoutButton}
            `;

            return header + content;
        }

        // --- Card Interaction Logic ---

        function clearLongPressTimer() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        /**
         * Starts the timer to detect a long press (full card image upload).
         */
        function cardInteractionStart(event) {
            // Prevent interference from nested elements (like the small profile image input)
            if (event.target.closest('#card-image-wrapper') || event.target.id === 'full-card-front-input') {
                return; 
            }
            
            clearLongPressTimer(); 
            
            longPressTimer = setTimeout(() => {
                const fileInput = document.getElementById('full-card-front-input');
                if (fileInput) {
                    fileInput.click();
                }
                longPressTimer = null; // Clear timer after successful long press action
            }, LONG_PRESS_DURATION);
        }

        /**
         * Ends the interaction. If it was a short click/tap, flip the card.
         */
        function cardInteractionEnd(event) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
                // If the timer was cleared before it fired (short press), flip the card.
                flipCard();
            }
            // If longPressTimer is already null, it means the long press event fired and file dialog opened.
        }

        function flipCard() {
            if (currentView !== 'cards') return; 

            isCardFlipped = !isCardFlipped;
            const cardElement = document.getElementById('id-card');
            if (cardElement) {
                if (isCardFlipped) {
                    cardElement.classList.add('flipped');
                } else {
                    cardElement.classList.remove('flipped');
                }
            }
        }

        /**
         * Handles image uploads for small profile picture, card back, and full card front.
         */
        function handleImageChange(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const url = e.target.result;
                if (type === 'profile') {
                    profileImageUrl = url;
                    // Update all profile images across views
                    document.querySelectorAll('#card-profile-img, #header-profile-img, #profile-card-img').forEach(img => {
                        img.src = profileImageUrl;
                    });
                } else if (type === 'back') {
                    cardBackImageUrl = url;
                    document.getElementById('card-back-img-display').src = cardBackImageUrl;
                } else if (type === 'full_card_front') {
                    // Update the custom image state for the currently active card
                    if (currentCard === 'student') {
                        studentCardFrontImageUrl = url;
                    } else if (currentCard === 'residence') {
                        residenceCardFrontImageUrl = url;
                    }
                    // Re-render the cards view to show the new background immediately
                    showView('cards');
                }
                event.target.value = ''; // Clear file input
            };
            reader.readAsDataURL(file);
        }

        /**
         * Reads and saves changes from the Profile View form inputs to USER_DATA.
         */
        function saveProfileChanges() {
            // ... (Save logic remains the same) ...
            const newSurname = document.getElementById('edit-surname-ar')?.value.trim();
            const newFirstname = document.getElementById('edit-firstname-ar')?.value.trim();
            const newNameEn = document.getElementById('edit-name-en')?.value.trim();
            const newPOB = document.getElementById('edit-pob-ar')?.value.trim();
            const newDOB = document.getElementById('edit-dob')?.value;
            const newLanguage = document.getElementById('edit-language')?.value;
            const newUniversityEn = document.getElementById('edit-university-en')?.value.trim();

            if (!newNameEn || !newSurname || !newFirstname || !newPOB || !newDOB || !newLanguage || !newUniversityEn) {
                console.error("يرجى التأكد من ملء جميع الحقول المطلوبة.");
                return;
            }

            USER_DATA.surname_ar = newSurname;
            USER_DATA.firstname_ar = newFirstname;
            USER_DATA.name_en = newNameEn; 
            USER_DATA.name_ar = `${newSurname} ${newFirstname}`; 
            USER_DATA.pob_ar = newPOB;
            USER_DATA.dob = newDOB;
            USER_DATA.language = newLanguage;
            USER_DATA.university_en = newUniversityEn;

            if (newUniversityEn.toLowerCase().includes('bejaia')) {
                USER_DATA.university_ar = "جامعة بجاية";
            } else {
                USER_DATA.university_ar = newUniversityEn; 
            }

            // Clear custom image if any text data changes, forcing fallback to default design
            // if (studentCardFrontImageUrl || residenceCardFrontImageUrl) {
            //     studentCardFrontImageUrl = null;
            //     residenceCardFrontImageUrl = null;
            // }

            showView('profile'); 
            
            console.log("تم حفظ بيانات الملف الشخصي بنجاح.", USER_DATA);
        }

        // --- Main Logic ---

        function showView(view) {
            currentView = view;
            const contentDiv = document.getElementById('main-content');
            
            switch (view) {
                case 'home':
                    contentDiv.innerHTML = renderHomeView();
                    break;
                case 'cards':
                    // Note: We intentionally don't reset isCardFlipped here for a better UX
                    contentDiv.innerHTML = renderCardsView();
                    updateCardToggle(currentCard);
                    break;
                case 'profile':
                    contentDiv.innerHTML = renderProfileView();
                    break;
                default:
                    contentDiv.innerHTML = `<div>View not found: ${view}</div>`;
            }
            
            updateNav(view);
            lucide.createIcons();
            contentDiv.scrollTop = 0;
        }
        
        function switchCard(cardType) {
            currentCard = cardType;
            isCardFlipped = false; // Reset flip when switching card type
            showView('cards');
        }
        
        function updateCardToggle(activeCard) {
            const studentBtn = document.getElementById('toggle-student');
            const residenceBtn = document.getElementById('toggle-residence');
            
            [studentBtn, residenceBtn].forEach(btn => {
                if (!btn) return;
                
                if (btn.id.includes(activeCard)) {
                    btn.classList.add('bg-primary-green', 'text-white');
                    btn.classList.remove('bg-white', 'text-gray-700', 'border');
                } else {
                    btn.classList.remove('bg-primary-green', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200');
                }
            });
        }


        // Initialize the app on page load
        window.onload = () => {
            showView(currentView);
        };
    </script>

</body>
</html>
