<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Mobile UI</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font: Inter is the default, but we'll prioritize system fonts for better Arabic rendering -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&display=swap');
        :root {
            --color-primary-green: #00A37A;
            --color-dark-slate: #383E58;
            --color-logout-red: #E85A5A;
            --color-light-bg: #F0F0F0;
        }

        body {
            background-color: var(--color-light-bg);
            font-family: 'Almarai', 'Inter', sans-serif;
        }

        /* Utility class for the primary green color, matching the screenshots */
        .bg-primary-green { background-color: var(--color-primary-green); }
        .text-primary-green { color: var(--color-primary-green); }
        .bg-dark-slate { background-color: var(--color-dark-slate); }
        .bg-logout-red { background-color: var(--color-logout-red); }

        /* Ensure the app container simulates a mobile screen */
        #app-container {
            max-width: 420px; /* iPhone 12 Pro Max width for accurate representation */
            min-height: 100vh;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            background-color: white; /* Inner app background */
        }
        
        /* Custom styles for the intricate ID card design */
        .id-card-container {
            perspective: 1000px;
            height: 400px; /* Fixed height for the flip effect */
            margin-top: 1rem;
        }

        .id-card {
            background: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 1.5rem; /* rounded-3xl */
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        
        /* Card Flip State */
        .id-card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1.5rem;
            padding: 1.5rem;
            overflow: hidden;
        }

        .card-front {
            z-index: 2;
            transform: rotateY(0deg);
        }

        .card-back {
            background-color: #f7f7f7; /* Light background for the back */
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
        }

        /* Wavy line effect on the ID card front */
        .card-front::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(90deg, transparent 0 1px, var(--color-primary-green) 1px 3px);
            opacity: 0.1;
            z-index: 0;
        }

        /* Green vertical wavy border on the right (Front face only) */
        .card-front::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 100' preserveAspectRatio='none'%3E%3Cpath d='M0 0 C 8 25, 0 75, 8 100' stroke='%2300A37A' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");
            background-repeat: repeat-y;
            background-size: 8px 20px;
        }
        
        /* Specific card details alignment (Arabic text on the right) */
        .card-detail-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        /* Style for the hidden input file field */
        .profile-image-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            z-index: 10; /* Ensure it's clickable */
        }

    </style>
</head>
<body class="bg-light-bg">

    <div id="app-container" class="flex flex-col">

        <!-- Main Content Area -->
        <main id="main-content" class="flex-grow p-4 pb-24 overflow-y-auto">
            <!-- Views will be rendered here by JavaScript -->
        </main>

        <!-- Bottom Navigation (Footer) -->
        <nav id="bottom-nav" class="bg-dark-slate fixed bottom-0 left-0 right-0 z-50 h-20 shadow-2xl" style="max-width: 420px; margin: 0 auto;">
            <div class="flex h-full">
                <!-- Home Button -->
                <button data-view="home" class="nav-item flex-1 flex flex-col items-center justify-center text-white/70 transition-colors" onclick="showView('home')">
                    <i data-lucide="home" class="w-6 h-6"></i>
                    <span class="text-xs mt-1">الرئيسية</span>
                </button>
                <!-- Cards Button -->
                <button data-view="cards" class="nav-item flex-1 flex flex-col items-center justify-center text-white/70 transition-colors" onclick="showView('cards')">
                    <i data-lucide="credit-card" class="w-6 h-6"></i>
                    <span class="text-xs mt-1">البطاقات</span>
                </button>
                <!-- Profile Button -->
                <button data-view="profile" class="nav-item flex-1 flex flex-col items-center justify-center text-white/70 transition-colors" onclick="showView('profile')">
                    <i data-lucide="user" class="w-6 h-6"></i>
                    <span class="text-xs mt-1">الملف الشخصي</span>
                </button>
            </div>
        </nav>
    </div>

    <script>
        // --- Data Definitions ---
        const USER_DATA = {
            name_en: "BERKANI AMAYAS",
            name_ar: "بركاني أمياس",
            surname_ar: "بركاني",
            firstname_ar: "أمياس",
            university_en: "université de béjaia",
            university_ar: "جامعة بجاية",
            dob: "2005-12-04", 
            pob_ar: "بجاية",
            major_ar: "علوم الطبيعة والحياة",
            academic_year: "2025/2026",
            id_student: "UN0601202525353025418",
            id_residence: "4-203",
            card_residence_details: "يستفيد هذا الطالب من خدمات النقل",
            residence_building: "بريشاش 3",
            residence_room: "القمر",
            language: "ar-DZ", 
        };

        const HOME_SERVICES = [
            { en: "Discharge", ar: "إبراء الذمة", icon: "file-text" },
            { en: "Timetable", ar: "جدول الأعمال", icon: "calendar" },
            { en: "Group and Section", ar: "المجموعة والقسم", icon: "users" },
            { en: "Exams Schedule", ar: "جدول الامتحانات", icon: "calendar-check" },
            { en: "Exam Grades", ar: "نتائج الامتحانات", icon: "graduation-cap" },
            { en: "Assessment", ar: "التقييم", icon: "pencil" },
            { en: "Percentage (%)", ar: "النسبة المئوية", icon: "pie-chart" },
            { en: "Academic Transcripts", ar: "كشوف النقاط", icon: "folder-open" },
            { en: "Debts", ar: "الديون", icon: "calculator" },
            { en: "Academic vacation", ar: "عطلة أكاديمية", icon: "sun" },
            { en: "Enrollments", ar: "التسجيلات", icon: "credit-card" },
            { en: "Restoration", ar: "الاستعادة", icon: "utensils" },
            { en: "Other services", ar: "خدمات أخرى", icon: "grid" },
        ];

        // --- State Management ---
        let currentView = 'profile'; // Start on profile page to see the fix immediately
        let currentCard = 'student'; // 'student' or 'residence'
        let isCardFlipped = false;
        let profileImageUrl = "https://placehold.co/96x96/444444/ffffff?text=صورة"; // Default profile image
        let cardBackImageUrl = "https://placehold.co/380x380/00A37A/ffffff?text=صورة+خلفية"; // Default card back image
        
        // Timer for long press logic
        let longPressTimer = null;
        const LONG_PRESS_DURATION = 500; // milliseconds

        // --- Utility Functions ---

        /**
         * Renders the header for each view.
         * @param {string} title - The title of the page.
         * @param {boolean} showProfile - Whether to show the profile picture/icon (only on Home).
         */
        function renderHeader(title, showProfile = false) {
            const profileIcon = showProfile 
                ? `<div class="w-8 h-8 rounded-full overflow-hidden border-2 border-white/50">
                    <img id="header-profile-img" src="${profileImageUrl}" alt="Profile" class="w-full h-full object-cover"/>
                  </div>`
                : '';
            
            return `
                <header class="flex justify-between items-center h-16 pt-4 px-4">
                    <h1 class="text-xl font-bold">${title}</h1>
                    ${profileIcon}
                </header>
            `;
        }

        /**
         * Updates the active state of the bottom navigation bar.
         */
        function updateNav(view) {
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.view === view) {
                    item.classList.add('bg-primary-green', 'text-white');
                    item.classList.remove('text-white/70');
                } else {
                    item.classList.remove('bg-primary-green', 'text-white');
                    item.classList.add('text-white/70');
                }
            });
            // Re-render icons to match the screenshot style (filled for active, outline for inactive)
            lucide.createIcons();
        }
        
        /**
         * Renders a standardized detail card for fields.
         */
        const detailCard = (icon, title, value, editable = false, type = 'text', id = '') => `
            <div class="bg-white rounded-xl p-4 mb-4 flex items-center shadow-md" style="direction: rtl;">
                <div class="p-2 rounded-full bg-gray-100 text-primary-green flex-shrink-0">
                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                </div>
                <div class="mr-4 flex-grow text-right">
                    <p class="text-sm text-gray-500">${title}</p>
                    ${editable 
                        ? `<input type="${type}" id="${id}" value="${value}" 
                           class="bg-gray-100 text-black/80 text-base font-semibold w-full p-1 rounded-md text-right border border-transparent focus:border-primary-green transition-colors ${type === 'date' ? 'h-9' : ''}" 
                           placeholder="${type === 'date' ? 'YYYY-MM-DD' : ''}">`
                        : `<p class="text-base font-semibold text-black/80">${value}</p>`
                    }
                </div>
            </div>
        `;


        // --- View Renderers ---

        function renderHomeView() {
            const header = renderHeader("بوابة الطالب", true);
            
            const logoBlock = `
                <div class="bg-primary-green rounded-xl p-4 mb-6 shadow-md mt-2">
                    <div class="flex justify-center items-center h-20">
                        <!-- Placeholder for PROGRES Logo - Using a simple text version -->
                        <div class="text-center">
                            <h2 class="text-white text-2xl font-bold">PROGRES</h2>
                            <p class="text-white text-xs mt-1">وزارة التعليم العالي والبحث العلمي</p>
                            <p class="text-white text-xs">Ministère de l'Enseignement Supérieur et de la Recherche Scientifique</p>
                            <!-- Placeholder for flag -->
                            <div class="absolute right-4 top-4 w-4 h-3 bg-white rounded-sm border border-white/50"></div>
                        </div>
                    </div>
                </div>
            `;

            const serviceGrid = HOME_SERVICES.map(service => `
                <button class="bg-primary-green rounded-xl p-3 h-20 flex flex-col items-center justify-center text-white shadow-lg text-right" onclick="console.log('${service.en} clicked')">
                    <i data-lucide="${service.icon}" class="w-6 h-6 mb-1"></i>
                    <span class="text-sm font-semibold">${service.ar}</span>
                </button>
            `).join('');

            const content = `
                <div class="grid grid-cols-2 gap-3">
                    ${serviceGrid}
                </div>
            `;

            return header + logoBlock + content;
        }
        
        function renderCardFront(type) {
            const isStudent = type === 'student';

            // Government logo/text block (top left)
            const governmentBlock = isStudent
                ? `
                    <div class="absolute top-6 right-6 flex flex-col items-end text-xs font-semibold leading-tight pr-10">
                        <p>الجمهورية الجزائرية الديمقراطية الشعبية</p>
                        <p>وزارة التعليم العالي والبحث العلمي</p>
                        <p>مديرية الخدمات الجامعية</p>
                        <p>${USER_DATA.university_ar}</p>
                    </div>
                    <!-- Placeholder for Algerian Government Logo -->
                    <div class="absolute top-6 left-6 w-8 h-8 rounded-full bg-primary-green opacity-80 border-2 border-white"></div>
                `
                : `
                    <div class="absolute top-6 right-6 flex flex-col items-end text-xs font-semibold leading-tight pr-10">
                        <p>الجمهورية الجزائرية الديمقراطية الشعبية</p>
                        <p>وزارة التعليم العالي والبحث العلمي</p>
                        <p>مديرية الخدمات الجامعية بجاية القصر</p>
                    </div>
                    <!-- Placeholder for Algerian Government Logo -->
                    <div class="absolute top-6 left-6 w-8 h-8 rounded-full bg-primary-green opacity-80 border-2 border-white"></div>
                `;

            // Card Title (Vertical, centered)
            const cardTitle = isStudent 
                ? `<div class="absolute top-24 left-1/2 transform -translate-x-1/2 -rotate-90 origin-top-left text-3xl font-bold text-black/90">بطاقة الطالب</div>`
                : `<div class="absolute top-24 left-1/2 transform -translate-x-1/2 -rotate-90 origin-top-left text-3xl font-bold text-black/90">بطاقة الإقامة</div>`;


            // Profile Image (Top Center)
            // Added event listeners for long press simulation
            const profileImage = `
                <div id="card-image-wrapper" class="absolute top-4 left-1/2 transform -translate-x-1/2 w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-md bg-gray-200"
                    ontouchstart="handleTouchStart(event, 'card-image-input')" 
                    ontouchend="handleTouchEnd(event, 'card-image-input')"
                    onmousedown="handleMouseDown(event, 'card-image-input')" 
                    onmouseup="handleMouseUp(event, 'card-image-input')"
                    onmouseout="handleMouseUp(event, 'card-image-input')">
                    
                    <img id="card-profile-img" src="${profileImageUrl}" alt="Student Photo" class="w-full h-full object-cover"/>
                    <!-- Hidden Input field to change card image -->
                    <input type="file" id="card-image-input" accept="image/*" class="profile-image-input" onchange="handleImageChange(event, 'profile')">
                </div>
            `;

            // Data Fields
            const fieldLayout = isStudent ? `
                <div class="absolute top-36 right-4 text-xs font-semibold text-right">
                    <p class="mb-2">السنة الجامعية</p>
                    <p class="text-sm font-bold text-primary-green">${USER_DATA.academic_year}</p>
                    <p class="mt-4 text-sm font-bold tracking-widest text-primary-green transform rotate-90 origin-top-right whitespace-nowrap absolute right-0 top-1/2">${USER_DATA.id_student}</p>
                </div>

                <div class="absolute top-12 left-6 text-sm flex flex-col items-start font-semibold" style="direction: ltr; text-align: left;">
                    <div class="mt-14 space-y-2">
                        <div class="flex items-center space-x-4">
                            <span class="font-bold">${USER_DATA.firstname_ar}</span>
                            <span>الإسم</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="font-bold">${USER_DATA.surname_ar}</span>
                            <span>اللقب</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="font-bold">${USER_DATA.dob}</span>
                            <span>تاريخ و مكان الميلاد</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="font-bold text-primary-green">${USER_DATA.major_ar}</span>
                            <span>التخصص</span>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="absolute top-36 right-4 text-xs font-semibold text-right">
                    <p class="text-sm font-bold text-primary-green mt-2">${USER_DATA.card_residence_details}</p>
                </div>

                <div class="absolute top-12 left-6 text-sm flex flex-col items-start font-semibold" style="direction: ltr; text-align: left;">
                    <div class="mt-14 space-y-2">
                        <div class="flex items-center space-x-4">
                            <span class="font-bold">${USER_DATA.firstname_ar}</span>
                            <span>الإسم</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="font-bold">${USER_DATA.surname_ar}</span>
                            <span>اللقب</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="font-bold">${USER_DATA.dob}</span>
                            <span>تاريخ و مكان الميلاد</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="font-bold text-primary-green">${USER_DATA.residence_building} - ${USER_DATA.residence_room}</span>
                            <span>الإقامة</span>
                        </div>
                    </div>
                </div>
            `;

            // Common lower section (Name, QR, etc.)
            const lowerSection = `
                <div class="absolute bottom-16 w-full px-6 flex justify-between items-end text-xs font-semibold text-right">
                    <div class="card-detail-item">
                        <p class="font-bold text-sm">${USER_DATA.surname_ar}</p>
                        <p>اللقب</p>
                    </div>
                    <div class="card-detail-item">
                        <p class="font-bold text-sm">${USER_DATA.firstname_ar}</p>
                        <p>الإسم</p>
                    </div>
                    <div class="card-detail-item">
                        <p class="font-bold text-sm">${USER_DATA.name_en.split(' ')[1] || 'AMAYAS'}</p>
                        <p>Prenom</p>
                    </div>
                    <div class="card-detail-item">
                        <p class="font-bold text-sm">${USER_DATA.name_en.split(' ')[0] || 'BERKANI'}</p>
                        <p>Nom</p>
                    </div>
                </div>

                <!-- QR Code Placeholder -->
                <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 w-28 h-28 p-2 bg-white border border-gray-300">
                    <img src="https://placehold.co/100x100/1a1a1a/ffffff?text=QR" alt="QR Code" class="w-full h-full object-cover"/>
                </div>
            `;

            return `
                <div class="card-face card-front relative">
                    ${governmentBlock}
                    ${cardTitle}
                    ${profileImage}
                    ${fieldLayout}
                    ${lowerSection}
                </div>
            `;
        }

        function renderCardBack(type) {
            const isStudent = type === 'student';
            const backTitle = isStudent ? "الوجه الخلفي لبطاقة الطالب" : "الوجه الخلفي لبطاقة الإقامة";

            return `
                <div class="card-face card-back relative">
                    <h3 class="text-xl font-bold text-dark-slate mb-4">${backTitle}</h3>
                    <p class="text-sm text-gray-600 mb-6">انقر لقلب البطاقة مرة أخرى</p>

                    <!-- Back Image Display -->
                    <div class="w-4/5 max-w-xs h-40 rounded-xl overflow-hidden shadow-xl border-4 border-gray-300 mb-6">
                        <img id="card-back-img-display" src="${cardBackImageUrl}" alt="Card Back" class="w-full h-full object-cover"/>
                    </div>

                    <!-- Input field to change back image -->
                    <label for="backImageInput" class="bg-primary-green text-white px-4 py-2 rounded-lg font-semibold text-sm shadow-md cursor-pointer flex items-center">
                        <i data-lucide="image" class="w-5 h-5 ml-2"></i>
                        تغيير صورة الخلف
                    </label>
                    <input type="file" id="backImageInput" accept="image/*" class="hidden" onchange="handleImageChange(event, 'back')">
                </div>
            `;
        }


        function renderCardsView() {
            const cardToggle = `
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="toggle-student" class="p-2 w-full max-w-[150px] rounded-full text-sm font-semibold transition-all shadow-md" onclick="switchCard('student')">
                        بطاقة الطالب
                    </button>
                    <button id="toggle-residence" class="p-2 w-full max-w-[150px] rounded-full text-sm font-semibold transition-all shadow-md" onclick="switchCard('residence')">
                        بطاقة الإقامة
                    </button>
                </div>
            `;
            
            // Note: Removed the standard click handler from id-card-container 
            // to allow long-press detection on the card image itself.
            const cardContainer = `
                <div id="id-card-container" class="id-card-container" onclick="handleCardClick(event)">
                    <div id="id-card" class="id-card ${isCardFlipped ? 'flipped' : ''}">
                        ${renderCardFront(currentCard)}
                        ${renderCardBack(currentCard)}
                    </div>
                </div>
                <p class="text-center text-gray-500 text-sm mt-3">انقر على البطاقة لقلبها. اضغط مطولاً على الصورة لتغييرها.</p>
            `;

            const header = renderHeader("بطاقات الهوية");
            
            return header + cardToggle + cardContainer;
        }

        function renderProfileView() {
            // Header title is now based on the image provided in the user's context (My Profile / ملفي الشخصي)
            const header = renderHeader("ملفي الشخصي");

            // Profile Card (Now editable fields for Name)
            const editableProfileCard = `
                <div class="bg-primary-green rounded-xl p-4 mb-4 flex items-center shadow-lg mt-2" style="direction: rtl;">
                    <!-- Profile Image container -->
                    <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white/50 flex-shrink-0">
                        <img id="profile-card-img" src="${profileImageUrl}" alt="Profile" class="w-full h-full object-cover"/>
                    </div>
                    
                    <div class="mr-4 text-right text-white flex-grow">
                        <p class="text-xs font-light">الاسم بالإنجليزية (اللقب الاسم)</p>
                        <input type="text" id="edit-name-en" value="${USER_DATA.name_en}" placeholder="BERKANI AMAYAS" 
                            class="bg-white/20 text-white text-lg font-bold w-full p-1 rounded-md text-right border border-transparent focus:border-white/50 transition-colors mb-2" 
                            style="direction: ltr;">
                        
                        <p class="text-xs font-light mt-2">اللقب بالعربية</p>
                        <input type="text" id="edit-surname-ar" value="${USER_DATA.surname_ar}" placeholder="بركاني"
                            class="bg-white/20 text-white text-base w-full p-1 rounded-md text-right border border-transparent focus:border-white/50 transition-colors mb-2">
                        
                        <p class="text-xs font-light mt-2">الاسم بالعربية</p>
                        <input type="text" id="edit-firstname-ar" value="${USER_DATA.firstname_ar}" placeholder="أمياس"
                            class="bg-white/20 text-white text-base w-full p-1 rounded-md text-right border border-transparent focus:border-white/50 transition-colors">
                    </div>
                </div>
            `;

            // University Card (Editable field - Added this based on the screenshot provided)
            const editableUniversityCard = detailCard('school', 'الجامعة بالإنجليزية', USER_DATA.university_en, true, 'text', 'edit-university-en');

            // Save Button - Calls the saveProfileChanges function
            const saveButton = `
                <button id="save-button" class="bg-primary-green text-white w-full py-3 rounded-xl font-bold text-lg shadow-md transition-all hover:bg-opacity-90 mb-4" onclick="saveProfileChanges()">
                    حفظ التغييرات
                </button>
            `;

            // Place of Birth Card (Editable field)
            const editablePOBCard = detailCard('map-pin', 'مكان الميلاد', USER_DATA.pob_ar, true, 'text', 'edit-pob-ar');

            // Date of Birth Card (Editable field)
            const editableDOBCard = detailCard('cake', 'تاريخ الميلاد', USER_DATA.dob, true, 'date', 'edit-dob');
            
            // Language Card (Editable field)
            const languageCard = `
                <div class="bg-white rounded-xl p-4 mb-6 flex justify-between items-center shadow-md" style="direction: rtl;">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-gray-100 text-primary-green">
                            <i data-lucide="languages" class="w-5 h-5"></i>
                        </div>
                        <span class="mr-4 text-base font-semibold text-black/80">لغة التطبيق</span>
                    </div>
                    <select id="edit-language"
                            class="bg-gray-100 text-black/80 font-semibold px-4 py-2 rounded-lg text-sm appearance-none cursor-pointer border border-transparent focus:border-primary-green transition-colors">
                        <option value="ar-DZ" ${USER_DATA.language === 'ar-DZ' ? 'selected' : ''}>العربية (الجزائر)</option>
                        <option value="fr-DZ" ${USER_DATA.language === 'fr-DZ' ? 'selected' : ''}>الفرنسية (الجزائر)</option>
                        <option value="en-US" ${USER_DATA.language === 'en-US' ? 'selected' : ''}>الإنجليزية</option>
                    </select>
                </div>
            `;

            const logoutButton = `
                <button class="bg-logout-red text-white w-full py-3 rounded-xl font-bold text-lg shadow-md transition-all hover:bg-opacity-90" onclick="console.log('Logout clicked')">
                    تسجيل الخروج
                </button>
            `;

            const content = `
                ${editableProfileCard}
                ${editableUniversityCard} <!-- New University Field -->
                ${saveButton}
                ${editablePOBCard}
                ${editableDOBCard}
                ${languageCard}
                ${logoutButton}
            `;

            return header + content;
        }

        // --- Card Interaction Logic ---

        /**
         * Clears any running long press timer.
         */
        function clearLongPressTimer() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        /**
         * Handles the start of a touch/mouse press (long press simulation).
         * @param {Event} event - The touch or mouse event.
         * @param {string} inputId - ID of the hidden file input to trigger.
         */
        function handleTouchStart(event, inputId) {
            // Prevent default action (like scrolling) for touch events
            if (event.type === 'touchstart') {
                event.preventDefault(); 
            }
            clearLongPressTimer(); // Clear any existing timer
            
            // Start a new timer
            longPressTimer = setTimeout(() => {
                const fileInput = document.getElementById(inputId);
                if (fileInput) {
                    fileInput.click(); // Trigger the file input click after duration
                }
                longPressTimer = null; // Clear timer reference after execution
            }, LONG_PRESS_DURATION);
        }

        /**
         * Handles the end of a touch/mouse press (long press simulation).
         * @param {Event} event - The touch or mouse event.
         * @param {string} inputId - ID of the hidden file input associated.
         */
        function handleTouchEnd(event, inputId) {
            // If the timer is still running, it means it was a short click/tap, so we clear the timer
            if (longPressTimer) {
                clearTimeout(longPressTimer);
            }
        }

        /**
         * Mouse equivalent for handleTouchStart
         */
        function handleMouseDown(event, inputId) {
            // Only handle the primary mouse button (left click)
            if (event.button !== 0) return; 
            handleTouchStart(event, inputId);
        }

        /**
         * Mouse equivalent for handleTouchEnd
         */
        function handleMouseUp(event, inputId) {
            handleTouchEnd(event, inputId);
        }


        /**
         * Handles click on the card container to flip the card.
         * We need this wrapper to prevent the flip when the long-press starts.
         */
        function handleCardClick(event) {
             // If a long press timer was initiated but not completed, it's a short tap, so we flip.
             // If longPressTimer is null, the click came from a different element or was a normal tap.
            
            // Check if the click/tap originated from outside the image wrapper
            const imageWrapper = document.getElementById('card-image-wrapper');
            if (imageWrapper && imageWrapper.contains(event.target)) {
                // If it originated from the image, we rely on the long-press logic
                // If longPressTimer is not null here, it means it was a short tap on the image, so we ignore it.
                if (longPressTimer) {
                    clearLongPressTimer(); // Prevent file input from opening
                    flipCard(); // Treat short tap on image as flip
                }
                return;
            }
            
            // Flip the card if the click is anywhere else on the card or container
            flipCard();
        }

        /**
         * Flips the current card.
         */
        function flipCard() {
            if (currentView !== 'cards') return; 

            isCardFlipped = !isCardFlipped;
            const cardElement = document.getElementById('id-card');
            if (cardElement) {
                if (isCardFlipped) {
                    cardElement.classList.add('flipped');
                } else {
                    cardElement.classList.remove('flipped');
                }
            }
        }

        /**
         * Handles the change event for image inputs (both profile and card back).
         * @param {Event} event - The file input change event.
         * @param {string} type - 'profile' for profile image (used on card front), 'back' for card back image.
         */
        function handleImageChange(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const url = e.target.result;
                if (type === 'profile') {
                    profileImageUrl = url;
                    // Update all profile images across views
                    const imgElements = document.querySelectorAll('#card-profile-img, #header-profile-img, #profile-card-img');
                    imgElements.forEach(img => {
                        img.src = profileImageUrl;
                    });
                } else if (type === 'back') {
                    cardBackImageUrl = url;
                    // Update the card back image display
                    const backImg = document.getElementById('card-back-img-display');
                    if (backImg) {
                        backImg.src = cardBackImageUrl;
                    }
                }
                // Clear the input value so the same file can be selected again
                event.target.value = ''; 
            };
            reader.readAsDataURL(file);
        }

        /**
         * Reads and saves changes from the Profile View form inputs to USER_DATA.
         */
        function saveProfileChanges() {
            const newSurname = document.getElementById('edit-surname-ar')?.value.trim();
            const newFirstname = document.getElementById('edit-firstname-ar')?.value.trim();
            const newNameEn = document.getElementById('edit-name-en')?.value.trim();
            const newPOB = document.getElementById('edit-pob-ar')?.value.trim();
            const newDOB = document.getElementById('edit-dob')?.value;
            const newLanguage = document.getElementById('edit-language')?.value;
            const newUniversityEn = document.getElementById('edit-university-en')?.value.trim(); // Get new University value

            // Check if required inputs exist and are filled
            if (!newNameEn || !newSurname || !newFirstname || !newPOB || !newDOB || !newLanguage || !newUniversityEn) {
                console.error("يرجى التأكد من ملء جميع الحقول المطلوبة (الاسم، الجامعة، مكان وتاريخ الميلاد، واللغة).");
                // In a real app, display an error message on screen
                return;
            }

            // 1. Update Global Data
            USER_DATA.surname_ar = newSurname;
            USER_DATA.firstname_ar = newFirstname;
            USER_DATA.name_en = newNameEn; 
            // Derive Arabic full name from components
            USER_DATA.name_ar = `${newSurname} ${newFirstname}`; 
            USER_DATA.pob_ar = newPOB;
            USER_DATA.dob = newDOB;
            USER_DATA.language = newLanguage;
            USER_DATA.university_en = newUniversityEn; // Update University
            // NOTE: university_ar is not editable on the profile page, so we keep the current value.

            // 2. Re-render the current view to reflect the saved changes immediately
            // The user requested to see the updated profile page immediately after saving.
            showView('profile'); 
            
            // Log for debugging and confirmation
            console.log("تم حفظ بيانات الملف الشخصي بنجاح.", USER_DATA);
        }

        // --- Main Logic ---

        /**
         * Switches the active view and re-renders the content.
         */
        function showView(view) {
            currentView = view;
            const contentDiv = document.getElementById('main-content');
            
            // Render the correct view content
            switch (view) {
                case 'home':
                    contentDiv.innerHTML = renderHomeView();
                    contentDiv.style.direction = 'rtl';
                    document.documentElement.setAttribute('dir', 'rtl');
                    break;
                case 'cards':
                    isCardFlipped = false; 
                    contentDiv.innerHTML = renderCardsView();
                    contentDiv.style.direction = 'rtl';
                    document.documentElement.setAttribute('dir', 'rtl');
                    updateCardToggle(currentCard);
                    break;
                case 'profile':
                    contentDiv.innerHTML = renderProfileView();
                    contentDiv.style.direction = 'rtl';
                    document.documentElement.setAttribute('dir', 'rtl');
                    break;
                default:
                    contentDiv.innerHTML = `<div>View not found: ${view}</div>`;
            }
            
            updateNav(view);
            lucide.createIcons();
            contentDiv.scrollTop = 0;
        }
        
        /**
         * Switches the active card within the 'cards' view.
         */
        function switchCard(cardType) {
            currentCard = cardType;
            isCardFlipped = false; // Reset flip when switching card type
            
            // Use showView to fully re-render the cards content, ensuring all events are attached correctly
            showView('cards');
        }
        
        /**
         * Updates the visual style of the card toggle buttons.
         */
        function updateCardToggle(activeCard) {
            const studentBtn = document.getElementById('toggle-student');
            const residenceBtn = document.getElementById('toggle-residence');
            
            [studentBtn, residenceBtn].forEach(btn => {
                if (!btn) return;
                
                if (btn.id.includes(activeCard)) {
                    btn.classList.add('bg-primary-green', 'text-white');
                    btn.classList.remove('bg-white', 'text-gray-700', 'border');
                } else {
                    btn.classList.remove('bg-primary-green', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-200');
                }
            });
        }


        // Initialize the app on page load
        window.onload = () => {
            // Initial render: show the Profile view as requested for verification
            showView(currentView);
        };
    </script>

</body>
</html>

